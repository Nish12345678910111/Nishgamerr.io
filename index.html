<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Chat App — Full Features</title>
<script type="module" src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm"></script>
<style>
  body { background:#0b1220; color:#e6eef8; font-family: Inter, system-ui, sans-serif; display:flex; justify-content:center; padding:18px; }
  .wrap { width:100%; max-width:720px; }
  h1 { text-align:center; color:#60a5fa; margin-bottom:10px; }
  .top { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; gap:8px; flex-wrap:wrap; }
  #currentUsername { color:#94a3b8; font-size:0.9rem; margin-right:6px; }
  #username { background:#0f1724; color:#e6eef8; border:1px solid #1f2937; padding:6px 8px; border-radius:6px; width:45%; }
  #chat { background:#071127; border-radius:8px; padding:12px; height:420px; overflow-y:auto; border:1px solid #132033; margin-bottom:8px; }
  .message { margin-bottom:10px; display:flex; justify-content:space-between; align-items:flex-start; }
  .messageText { display:flex; flex-direction:column; }
  .username { color:#60a5fa; font-weight:700; font-size:0.95rem; margin-bottom:2px; }
  .ts { color:#94a3b8; font-size:0.78rem; }
  .controls { display:flex; gap:8px; margin-bottom:8px; flex-wrap:wrap; }
  #messageInput { flex:1; padding:10px; border-radius:8px; background:#0f1724; color:#e6eef8; border:1px solid #1f2937; }
  button { padding:10px 14px; border:none; border-radius:8px; cursor:pointer; }
  #sendBtn { background:#2563eb; color:white; }
  #saveName { background:#10b981; color:white; margin-left:4px; }
  .pending { opacity:0.6; font-style:italic; }
  #status { position:fixed; right:14px; top:14px; padding:6px 10px; border-radius:8px; font-weight:700; }
  .online { background:#16a34a; color:#052e0b; }
  .offline { background:#dc2626; color:#2b0202; }
  .msgBtn { background:#ef4444; color:white; margin-left:6px; font-size:0.75rem; padding:2px 6px; border-radius:6px; cursor:pointer; }
  #extraBtns { display:flex; gap:8px; margin-bottom:8px; flex-wrap:wrap; }
</style>
</head>
<body>
<div id="status" class="offline">Offline</div>
<div class="wrap">
  <h1>Modern Chat App</h1>
  <div class="top">
    <div>
      <span id="currentUsername">Username: Guest</span>
      <input id="username" placeholder="Enter username" />
      <button id="saveName">Save</button>
    </div>
    <div style="color:#94a3b8">
      Dark • Realtime
    </div>
  </div>

  <div id="extraBtns">
    <button id="toggleScroll">Auto-scroll: On</button>
    <button id="deleteAll">Delete All Messages</button>
  </div>

  <div id="chat" role="log" aria-live="polite"></div>

  <div class="controls">
    <input id="messageInput" placeholder="Type a message" />
    <button id="sendBtn">Send</button>
  </div>

  <div id="nameMsg" style="color:#fb7185; min-height:1.2em;"></div>
  <div id="errorBox" style="color:#fecaca; min-height:1.2em;"></div>
</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

const SUPABASE_URL = 'https://latrynkftllkwkesmohg.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxhdHJ5bmtmdGxsa3drZXNtb2hnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA4OTg5MzgsImV4cCI6MjA3NjQ3NDkzOH0.DBxC0tKd5axpldXK6CbKCR2rNqva-aerd_f985LTg0k';

const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { realtime: { timeout: 15000 } });

const chatEl = document.getElementById('chat');
const usernameEl = document.getElementById('username');
const saveNameBtn = document.getElementById('saveName');
const currentUsernameLabel = document.getElementById('currentUsername');
const messageInput = document.getElementById('messageInput');
const sendBtn = document.getElementById('sendBtn');
const statusEl = document.getElementById('status');
const errorBox = document.getElementById('errorBox');
const nameMsgEl = document.getElementById('nameMsg');
const toggleScrollBtn = document.getElementById('toggleScroll');
const deleteAllBtn = document.getElementById('deleteAll');

let currentUsername = localStorage.getItem('chatUsername') || '';
let autoScroll = true;
let pendingMessages = JSON.parse(localStorage.getItem('chatPending') || '[]');

// ======== HELPER FUNCTIONS ========
function escapeHtml(s){ return String(s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
function fmtTime(ts){ return new Date(ts).toLocaleString(); }
function showError(msg){ errorBox.textContent = msg; setTimeout(()=>{ if(errorBox.textContent===msg) errorBox.textContent=''; }, 4000); }
function flashNameMsg(txt){ nameMsgEl.textContent = txt; setTimeout(()=>nameMsgEl.textContent='',2200); }

// ======== ONLINE/OFFLINE ========
async function checkConnectivity(){
  try{
    const { data, error } = await supabase.from('messages').select('id').limit(1);
    if(error){ statusEl.textContent='Offline'; statusEl.className='offline'; return false; }
    statusEl.textContent='Online'; statusEl.className='online'; return true;
  }catch(e){ statusEl.textContent='Offline'; statusEl.className='offline'; return false; }
}
window.addEventListener('online', checkConnectivity);
window.addEventListener('offline', checkConnectivity);
checkConnectivity();

// ======== DISPLAY MESSAGE ========
function displayMessageRow(row, { pending=false }={}){
  const div = document.createElement('div');
  div.className='message'+(pending?' pending':'');
  const textDiv = document.createElement('div');
  textDiv.className='messageText';
  textDiv.innerHTML=`<span class="username">${escapeHtml(row.username)}</span>
                      <span>${escapeHtml(row.message)}</span>
                      <span class="ts">${fmtTime(row.created_at)}</span>`;
  div.appendChild(textDiv);
  const delBtn = document.createElement('button');
  delBtn.className='msgBtn';
  delBtn.textContent='Delete';
  delBtn.onclick = async()=>{
    try{
      const { error } = await supabase.from('messages').delete().eq('id', row.id);
      if(error){ showError('Delete failed'); console.error(error); return; }
      div.remove();
    }catch(e){ showError('Delete failed'); console.error(e); }
  };
  div.appendChild(delBtn);
  chatEl.appendChild(div);
  if(autoScroll) chatEl.scrollTop = chatEl.scrollHeight;
}

// ======== LOAD MESSAGES ========
async function loadMessages(){
  if(!await checkConnectivity()) return;
  chatEl.innerHTML='';
  try{
    const { data, error } = await supabase.from('messages').select().order('created_at',{ascending:true});
    if(error){ showError('Failed to load messages'); return; }
    data.forEach(r=>displayMessageRow(r));
    pendingMessages.forEach(p=>displayMessageRow(p,{pending:true}));
  }catch(e){ showError('Load failed'); console.error(e); }
}

// ======== SEND MESSAGE ========
async function sendMessage(){
  const txt = messageInput.value.trim();
  if(!txt){ return; }
  if(!currentUsername){ flashNameMsg('Set username first'); return; }

  const row = { username: currentUsername, message: txt, created_at: new Date().toISOString() };
  displayMessageRow(row,{pending:true});
  messageInput.value='';
  pendingMessages.push(row);
  localStorage.setItem('chatPending',JSON.stringify(pendingMessages));

  if(!await checkConnectivity()) return;

  try{
    const { data, error } = await supabase.from('messages').insert([{ username: currentUsername, message: txt }]);
    if(error){ showError('Send failed'); console.error(error); return; }
    // remove from pending
    pendingMessages = pendingMessages.filter(m=>m!==row);
    localStorage.setItem('chatPending',JSON.stringify(pendingMessages));
    loadMessages();
  }catch(e){ showError('Send exception'); console.error(e); }
}

// ======== USERNAME ========
saveNameBtn.onclick = ()=>{
  const name = usernameEl.value.trim();
  if(!name){ flashNameMsg('Enter username'); return; }
  currentUsername = name;
  localStorage.setItem('chatUsername',currentUsername);
  currentUsernameLabel.textContent='Username: '+currentUsername;
  flashNameMsg('Username saved');
};
if(currentUsername){ usernameEl.value=currentUsername; currentUsernameLabel.textContent='Username: '+currentUsername; }

// ======== REALTIME ========
async function subscribeRealtime(){
  try{
    supabase.removeAllChannels();
    await supabase.channel('realtime-messages')
      .on('postgres_changes',{event:'INSERT',schema:'public',table:'messages'},payload=>{
        displayMessageRow(payload.new);
      })
      .subscribe();
  }catch(e){ console.error(e); showError('Realtime failed'); }
}

// ======== AUTO-SCROLL TOGGLE ========
toggleScrollBtn.onclick = ()=>{
  autoScroll=!autoScroll;
  toggleScrollBtn.textContent='Auto-scroll: '+(autoScroll?'On':'Off');
};

// ======== DELETE ALL ========
deleteAllBtn.onclick = async()=>{
  if(!confirm('Delete all messages?')) return;
  try{
    const { error } = await supabase.from('messages').delete().neq('id',0);
    if(error){ showError('Delete all failed'); console.error(error); return; }
    chatEl.innerHTML='';
  }catch(e){ showError('Delete all failed'); console.error(e); }
};

// ======== INIT ========
(async function init(){
  await subscribeRealtime();
  await loadMessages();
  sendBtn.onclick = sendMessage;
  messageInput.addEventListener('keydown',e=>{ if(e.key==='Enter') sendMessage(); });
})();
</script>
</body>
  </html>

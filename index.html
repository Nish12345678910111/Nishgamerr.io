<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Modern Chat</title>
<style>
body {
  font-family: Arial, sans-serif;
  background: #222;
  color: #fff;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 100vh;
  margin: 0;
}
.chat-box {
  width: 95%;
  max-width: 420px;
  background: #333;
  border-radius: 10px;
  padding: 10px;
  display: flex;
  flex-direction: column;
}
.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.status {
  font-size: 14px;
  color: #0f0;
}
.messages {
  flex: 1;
  overflow-y: auto;
  margin: 10px 0;
  background: #222;
  padding: 10px;
  border-radius: 6px;
}
.message {
  background: #444;
  padding: 8px;
  margin: 5px 0;
  border-radius: 6px;
}
.message .meta {
  font-size: 11px;
  color: #bbb;
  margin-top: 3px;
}
.input-area {
  display: flex;
}
input {
  flex: 1;
  padding: 8px;
  border: none;
  border-radius: 6px;
}
button {
  margin-left: 5px;
  padding: 8px 10px;
  border: none;
  border-radius: 6px;
  background: #0af;
  color: white;
}
button:hover { background: #08f; cursor: pointer; }
.bottom-buttons {
  display: flex;
  justify-content: space-between;
  margin-top: 5px;
}
</style>
</head>
<body>

<div class="chat-box">
  <div class="header">
    <div><b>Modern Chat</b></div>
    <div class="status" id="status">Offline</div>
  </div>

  <div id="usernameDisplay">Username: <span id="username"></span></div>

  <div class="messages" id="messages"></div>

  <div class="input-area">
    <input id="messageInput" placeholder="Type a message..." />
    <button id="sendBtn">Send</button>
  </div>

  <div class="bottom-buttons">
    <button id="autoScrollBtn">Auto Scroll: ON</button>
    <button id="deleteAllBtn">Delete All</button>
  </div>
</div>

<script>
// === CONFIG ===
const SUPABASE_URL = "https://latrynkftllkwkesmohg.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxhdHJ5bmtmdGxsa3drZXNtb2hnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA4OTg5MzgsImV4cCI6MjA3NjQ3NDkzOH0.DBxC0tKd5axpldXK6CbKCR2rNqva-aerd_f985LTg0k";
const TABLE = "messages";
const API_HEADERS = {
  "Content-Type": "application/json",
  "apikey": SUPABASE_KEY,
  "Authorization": `Bearer ${SUPABASE_KEY}`
};

// === ELEMENTS ===
const statusEl = document.getElementById("status");
const msgBox = document.getElementById("messages");
const msgInput = document.getElementById("messageInput");
const sendBtn = document.getElementById("sendBtn");
const deleteAllBtn = document.getElementById("deleteAllBtn");
const autoScrollBtn = document.getElementById("autoScrollBtn");
const usernameDisplay = document.getElementById("username");
let autoScroll = true;

// === USERNAME FROM DEVICE/IP ===
let username = localStorage.getItem("username");
if (!username) {
  username = "User" + Math.floor(Math.random() * 9999);
  localStorage.setItem("username", username);
}
usernameDisplay.textContent = username;

// === CONNECTION STATUS CHECK ===
async function checkOnline() {
  try {
    const res = await fetch(`${SUPABASE_URL}/rest/v1/${TABLE}?limit=1`, { headers: API_HEADERS });
    if (res.ok) {
      statusEl.textContent = "Online";
      statusEl.style.color = "#0f0";
      loadMessages();
    } else throw new Error();
  } catch {
    statusEl.textContent = "Offline";
    statusEl.style.color = "red";
  }
}

// === LOAD MESSAGES ===
async function loadMessages() {
  const res = await fetch(`${SUPABASE_URL}/rest/v1/${TABLE}?select=*`, { headers: API_HEADERS });
  const data = await res.json();
  msgBox.innerHTML = "";
  data.forEach(m => addMessage(m));
  if (autoScroll) msgBox.scrollTop = msgBox.scrollHeight;
}

// === ADD MESSAGE TO CHAT ===
function addMessage(m) {
  const div = document.createElement("div");
  div.className = "message";
  div.innerHTML = `<b>${m.username}:</b> ${m.message}
    <div class="meta">${new Date(m.created_at).toLocaleString()} 
    <button onclick="deleteMessage(${m.id})" style="float:right;background:red;color:white;border:none;padding:2px 5px;border-radius:3px;">Del</button></div>`;
  msgBox.appendChild(div);
}

// === SEND MESSAGE ===
sendBtn.onclick = async () => {
  const text = msgInput.value.trim();
  if (!text) return;
  const body = JSON.stringify({ username, message: text });
  const res = await fetch(`${SUPABASE_URL}/rest/v1/${TABLE}`, {
    method: "POST", headers: API_HEADERS, body
  });
  if (res.ok) {
    msgInput.value = "";
    loadMessages();
  } else alert("Failed to send");
};

// === DELETE ONE MESSAGE ===
async function deleteMessage(id) {
  if (!confirm("Delete this message?")) return;
  const res = await fetch(`${SUPABASE_URL}/rest/v1/${TABLE}?id=eq.${id}`, {
    method: "DELETE", headers: API_HEADERS
  });
  if (res.ok) loadMessages();
  else alert("Delete failed");
}

// === DELETE ALL MESSAGES ===
deleteAllBtn.onclick = async () => {
  if (!confirm("Delete ALL messages?")) return;
  const res = await fetch(`${SUPABASE_URL}/rest/v1/${TABLE}`, {
    method: "DELETE", headers: API_HEADERS
  });
  if (res.ok) loadMessages();
};

// === AUTO SCROLL TOGGLE ===
autoScrollBtn.onclick = () => {
  autoScroll = !autoScroll;
  autoScrollBtn.textContent = "Auto Scroll: " + (autoScroll ? "ON" : "OFF");
};

// === REFRESH MESSAGES EVERY 5s ===
setInterval(() => {
  if (statusEl.textContent === "Online") loadMessages();
}, 5000);

checkOnline();
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Supabase Chat</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #0e0e0e;
    color: white;
    margin: 0;
    display: flex;
    flex-direction: column;
    height: 100vh;
  }
  #chat {
    flex: 1;
    overflow-y: auto;
    padding: 10px;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  .msg {
    background: #1e1e1e;
    padding: 8px 10px;
    border-radius: 10px;
    width: fit-content;
    max-width: 80%;
    position: relative;
    word-wrap: break-word;
  }
  .own { background: #2b5cff; align-self: flex-end; }
  .meta { font-size: 10px; color: #aaa; margin-top: 2px; }
  .delBtn {
    position: absolute;
    right: -5px;
    top: -5px;
    background: #ff4040;
    color: white;
    border: none;
    border-radius: 50%;
    font-size: 8px;
    width: 15px;
    height: 15px;
    cursor: pointer;
  }
  #input-area {
    display: flex;
    padding: 10px;
    background: #111;
  }
  #message {
    flex: 1;
    padding: 10px;
    border: none;
    border-radius: 8px;
    outline: none;
  }
  #sendBtn {
    margin-left: 5px;
    background: #2b5cff;
    color: white;
    border: none;
    padding: 10px 15px;
    border-radius: 8px;
    cursor: pointer;
  }
  #usernameModal {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.9);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    gap: 10px;
  }
  #usernameModal input {
    padding: 10px;
    border: none;
    border-radius: 8px;
  }
  #usernameModal button {
    padding: 10px 15px;
    border: none;
    border-radius: 8px;
    background: #2b5cff;
    color: white;
    cursor: pointer;
  }
</style>
</head>
<body>
<div id="chat"></div>

<div id="input-area">
  <input type="text" id="message" placeholder="Type message...">
  <button id="sendBtn">Send</button>
</div>

<div id="usernameModal">
  <h2>Set your username</h2>
  <input type="text" id="usernameInput" placeholder="Enter username">
  <button id="setUsernameBtn">Set Username</button>
  <p id="errorMsg" style="color:red;"></p>
</div>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL = "https://xvnbxdcqmfsnnvbugasi.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh2bmJ4ZGNxbWZzbm52YnVnYXNpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA2OTE5NjIsInVwZGF0ZWQiOjIwNzYyNjc5NjJ9.vQELSSzCZtFi8jXGWcc8Qn_PV0W_dpmd_R3nF3zg0H0";
const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const chatDiv = document.getElementById("chat");
const msgInput = document.getElementById("message");
const sendBtn = document.getElementById("sendBtn");
const usernameModal = document.getElementById("usernameModal");
const usernameInput = document.getElementById("usernameInput");
const setUsernameBtn = document.getElementById("setUsernameBtn");
const errorMsg = document.getElementById("errorMsg");

let username = localStorage.getItem("username");

if (username) {
  usernameModal.style.display = "none";
} else {
  usernameModal.style.display = "flex";
}

// username setup
setUsernameBtn.onclick = async () => {
  const entered = usernameInput.value.trim();
  if (!entered) return;
  const { data } = await supabase.from("messages").select("username").eq("username", entered);
  if (data.length > 0) {
    errorMsg.textContent = "Username already taken!";
    return;
  }
  username = entered;
  localStorage.setItem("username", username);
  usernameModal.style.display = "none";
};

// send message
sendBtn.onclick = async () => {
  const text = msgInput.value.trim();
  if (!text) return;
  msgInput.value = "";
  await supabase.from("messages").insert({ username, message: text });
  await loadMessages();
};

// delete message
async function deleteMessage(id) {
  await supabase.from("messages").delete().eq("id", id);
  await loadMessages();
}

// load messages
async function loadMessages() {
  const { data } = await supabase.from("messages").select("*").order("created_at", { ascending: true });
  chatDiv.innerHTML = "";
  data.forEach(msg => {
    const div = document.createElement("div");
    div.className = "msg" + (msg.username === username ? " own" : "");
    div.innerHTML = `
      <b>${msg.username}</b><br>${msg.message}
      <div class="meta">${new Date(msg.created_at).toLocaleString()}</div>
    `;
    if (msg.username === username) {
      const btn = document.createElement("button");
      btn.className = "delBtn";
      btn.textContent = "x";
      btn.onclick = () => deleteMessage(msg.id);
      div.appendChild(btn);
    }
    chatDiv.appendChild(div);
  });
  chatDiv.scrollTop = chatDiv.scrollHeight;
}

// auto refresh every 1 sec
setInterval(loadMessages, 1000);
loadMessages();
</script>
</body>
</html>

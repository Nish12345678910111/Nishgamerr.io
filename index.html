<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Modern Chat</title>
<script type="module" src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm"></script>
<style>
  body { background:#0b1220; color:#e6eef8; font-family:Inter,system-ui,sans-serif; display:flex; justify-content:center; padding:18px; margin:0; }
  .wrap { width:100%; max-width:720px; }
  h1 { text-align:center; color:#60a5fa; margin-bottom:8px; font-size:1.2rem; }
  .top { display:flex; justify-content:space-between; align-items:center; gap:8px; margin-bottom:8px; flex-wrap:wrap; }
  #currentUsername { color:#94a3b8; font-size:0.95rem; }
  #username { background:#0f1724; color:#e6eef8; border:1px solid #1f2937; padding:6px 8px; border-radius:6px; width:48%; }
  #chat { background:#071127; border-radius:8px; padding:12px; height:320px; overflow-y:auto; border:1px solid #132033; }
  .message { margin-bottom:10px; display:flex; align-items:center; justify-content:space-between; gap:8px; }
  .message .info { display:flex; gap:8px; align-items:center; flex:1; }
  .username { color:#60a5fa; font-weight:700; }
  .text { color:#e6eef8; }
  .ts { color:#94a3b8; font-size:0.82rem; }
  .delBtn { width:18px; height:18px; font-size:12px; border:none; border-radius:3px; background:#fb7185; color:white; cursor:pointer; flex-shrink:0; }
  #controls { display:flex; gap:8px; margin-top:10px; }
  #messageInput { flex:1; padding:10px; border-radius:8px; background:#0f1724; color:#e6eef8; border:1px solid #1f2937; }
  #sendBtn, #delAllBtn, #autoScrollBtn, #changeNameBtn, #saveName { padding:10px 14px; background:#2563eb; border:none; border-radius:8px; color:white; cursor:pointer; }
  #nameMsg { color:#fb7185; font-size:0.9rem; margin-top:6px; min-height:1.2em; }
  .pending { opacity:0.6; font-style:italic; }
  #status { position:fixed; right:14px; top:14px; padding:6px 10px; border-radius:8px; font-weight:700; box-shadow:0 2px 6px rgba(0,0,0,0.4); }
  .online { background:#16a34a; color:#052e0b; } .offline { background:#dc2626; color:#2b0202; }
  #errorBox { margin-top:8px; color:#fecaca; min-height:1.2em; }
</style>
</head>
<body>
  <div id="status" class="offline">Offline</div>
  <div class="wrap">
    <h1>Modern Chat</h1>
    <div class="top">
      <div>
        <span id="currentUsername">Username: Guest</span>
        <input id="username" placeholder="Enter username" />
        <button id="saveName">Save</button>
        <button id="changeNameBtn" title="Change username">Change</button>
        <div id="nameMsg"></div>
      </div>
      <div class="btnRow">
        <button id="autoScrollBtn" title="Toggle auto scroll">Auto Scroll: ON</button>
        <button id="delAllBtn" title="Delete all my messages">Delete All (mine)</button>
      </div>
    </div>
    <div id="chat" role="log" aria-live="polite"></div>
    <div id="controls">
      <input id="messageInput" placeholder="Type a message" />
      <button id="sendBtn">Send</button>
    </div>
    <div id="errorBox"></div>
  </div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

const SUPABASE_URL = 'https://xvnbxdcqmfsnnvbugasi.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh2bmJ4ZGNxbWZzbm52YnVnYXNpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA2OTE5NjIsImV4cCI6MjA3NjI2Nzk2Mn0.vQELSSzCZtFi8jXGWcc8Qn_PV0W_dpmd_R3nF3zg0H0';

const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { realtime: { timeout: 15000, params: { eventsPerSecond: 100 } } });

/* DOM refs */
const chatEl = document.getElementById('chat');
const usernameEl = document.getElementById('username');
const saveNameBtn = document.getElementById('saveName');
const changeNameBtn = document.getElementById('changeNameBtn');
const nameMsgEl = document.getElementById('nameMsg');
const currentUsernameLabel = document.getElementById('currentUsername');
const messageInput = document.getElementById('messageInput');
const sendBtn = document.getElementById('sendBtn');
const delAllBtn = document.getElementById('delAllBtn');
const autoScrollBtn = document.getElementById('autoScrollBtn');
const statusEl = document.getElementById('status');
const errorBox = document.getElementById('errorBox');

/* State */
let currentUsername = localStorage.getItem('chatUsername') || '';
let autoScroll = localStorage.getItem('autoScroll') !== 'false';
let deviceId = localStorage.getItem('chat_device_id') || crypto.randomUUID();
if(!localStorage.getItem('chat_device_id')) localStorage.setItem('chat_device_id', deviceId);

const OWNED_IDS_KEY = 'owned_message_ids_v_final';
const PENDING_KEY = 'chat_pending_v_final';

function getOwnedIds(){ return JSON.parse(localStorage.getItem(OWNED_IDS_KEY)||'[]'); }
function addOwnedId(id){ const a=getOwnedIds(); if(!a.includes(String(id))) a.push(String(id)); localStorage.setItem(OWNED_IDS_KEY,JSON.stringify(a)); }
function removeOwnedId(id){ const a=getOwnedIds().filter(x=>String(x)!==String(id)); localStorage.setItem(OWNED_IDS_KEY,JSON.stringify(a)); }
function getPending(){ return JSON.parse(localStorage.getItem(PENDING_KEY)||'[]'); }
function setPending(arr){ localStorage.setItem(PENDING_KEY,JSON.stringify(arr)); }
function addPending(obj){ const a=getPending(); a.push(obj); setPending(a); }
function removePendingByMatch(username,message,created_at){ const a=getPending().filter(x=>!(x.username===username && x.message===message && x.created_at===created_at)); setPending(a); }

function escapeHtml(s){ return String(s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
function fmtTime(ts){ try{ return new Date(ts).toLocaleString(); } catch{return '??:??';} }
function showError(msg){ errorBox.textContent=msg; setTimeout(()=>{if(errorBox.textContent===msg)errorBox.textContent='';},4000); }
function flashNameMsg(txt){ nameMsgEl.textContent=txt; setTimeout(()=>nameMsgEl.textContent='',2200); }
function updateAutoScrollBtn(){ autoScrollBtn.textContent=`Auto Scroll: ${autoScroll?'ON':'OFF'}`; autoScrollBtn.style.background=autoScroll?'#2563eb':'#475569'; }

/* ================== Connectivity ================== */
async function checkConnectivity() {
  try {
    const { data, error } = await supabase.from('messages').select('id').limit(1);
    if(error) throw error;
    statusEl.textContent = 'Online';
    statusEl.className = 'online';
  } catch {
    statusEl.textContent = 'Offline';
    statusEl.className = 'offline';
  }
}

/* Realtime listeners */
if(supabase.realtime?.connection){
  supabase.realtime.connection.on('open',()=>{statusEl.textContent='Online';statusEl.className='online';});
  supabase.realtime.connection.on('close',()=>{statusEl.textContent='Offline';statusEl.className='offline';});
  supabase.realtime.connection.on('error',()=>{statusEl.textContent='Offline';statusEl.className='offline';});
} else {
  setInterval(checkConnectivity,10000);
}

/* ================== Messages ================== */
function displayMessageRow(row,{pending=false,localPending=false}={}){
  if(row.id && chatEl.querySelector(`[data-id='${row.id}']`)) return;
  if(pending && row._pending_key && chatEl.querySelector(`[data-pending='${row._pending_key}']`)) return;

  const username = row.username ?? 'Unknown';
  const message = row.message ?? '';
  const created_at = row.created_at ?? new Date().toISOString();

  const wrapper=document.createElement('div');
  wrapper.className='message'+(pending?' pending':'');
  if(row.id) wrapper.dataset.id=String(row.id);
  if(pending && row._pending_key) wrapper.dataset.pending=String(row._pending_key);

  const info=document.createElement('div');
  info.className='info';
  info.innerHTML=`<span class="username">${escapeHtml(username)}</span>
                  <span class="text">${escapeHtml(message)}</span>
                  <span class="ts">[${fmtTime(created_at)}]</span>`;
  wrapper.appendChild(info);

  const ownedByThisDevice = (row.device_id&&row.device_id===deviceId)||(row.id&&getOwnedIds().includes(String(row.id)))||localPending===true;

  if(ownedByThisDevice){
    const delBtn=document.createElement('button');
    delBtn.className='delBtn';
    delBtn.title='Delete message';
    delBtn.textContent='Ã—';
    delBtn.onclick=async e=>{
      e.stopPropagation();
      if(!row.id && localPending){wrapper.remove();removePendingByMatch(username,message,created_at);return;}
      const ok = await deleteMessage(row,wrapper);
      if(!ok) showError('Delete failed');
    };
    wrapper.appendChild(delBtn);
  } else {
    const spacer=document.createElement('div');spacer.style.width='22px';wrapper.appendChild(spacer);
  }

  chatEl.appendChild(wrapper);
  if(autoScroll) chatEl.scrollTop=chatEl.scrollHeight;
}

async function loadMessages(){
  try{
    const {data,error}=await supabase.from('messages').select('id,username,message,created_at,device_id').order('created_at',{ascending:true});
    if(error) { console.warn(error); chatEl.innerHTML=''; return; }
    chatEl.innerHTML='';
    data.forEach(r=>{displayMessageRow(r);if(r.device_id===deviceId&&r.id) addOwnedId(r.id);});
    getPending().forEach(p=>displayMessageRow(p,{pending:true,localPending:true}));
  } catch(e){console.error(e);showError('Load failed');}
}

async function sendMessage(){
  const txt=messageInput.value.trim();
  if(!txt) return;
  if(!currentUsername){flashNameMsg('Set username first');return;}
  const created_at=new Date().toISOString();
  const pendingKey=crypto.randomUUID();
  const localPending={username:currentUsername,message:txt,created_at,_pending_key:pendingKey};
  displayMessageRow(localPending,{pending:true,localPending:true});
  addPending(localPending);
  messageInput.value='';
  if(!navigator.onLine) return;

  try{
    const {data,error}=await supabase.from('messages').insert([{username:currentUsername,message:txt,device_id:deviceId,created_at}]).select().maybeSingle();
    if(error){ showError('Send failed; queued locally.'); return; }
    if(data){ removePendingByMatch(currentUsername,txt,created_at); if(data.id) addOwnedId(String(data.id)); displayMessageRow(data); }
  }catch(e){ showError('Send exception; queued locally.'); }
}

async function deleteMessage(row,domNode){
  if(!row||!row.id) return false;
  const owned=(row.device_id&&row.device_id===deviceId)||getOwnedIds().includes(String(row.id));
  if(!owned){showError('Cannot delete: not owned');return false;}
  try{
    const {error}=await supabaseconst { error } = await supabase.from('messages').delete().eq('id', row.id);
    if(error){ showError('Failed to delete'); return false; }
    removeOwnedId(row.id);
    if(domNode) domNode.remove();
    return true;
  } catch(e){ showError('Delete exception'); return false; }
}

/* Delete all my messages with 2-step confirmation */
let delAllStep = 0;
delAllBtn.onclick = async ()=>{
  if(!currentUsername){ flashNameMsg('Set username first'); return; }
  if(delAllStep===0){ flashNameMsg('Click again to confirm'); delAllStep=1; setTimeout(()=>delAllStep=0,3000); return; }
  delAllStep=0;
  try{
    const ownedIds = getOwnedIds();
    for(const id of ownedIds){
      await supabase.from('messages').delete().eq('id',id);
      removeOwnedId(id);
      const domRow = chatEl.querySelector(`[data-id='${id}']`);
      if(domRow) domRow.remove();
    }
    showError('All my messages deleted');
  } catch(e){ showError('Failed to delete all'); }
};

/* Auto-scroll toggle */
autoScrollBtn.onclick = ()=>{
  autoScroll = !autoScroll;
  localStorage.setItem('autoScroll', autoScroll);
  updateAutoScrollBtn();
};

/* Username handling */
function setUsername(name){
  if(!name) return;
  currentUsername = name;
  localStorage.setItem('chatUsername', name);
  currentUsernameLabel.textContent = 'Username: '+name;
  flashNameMsg('Username saved');
}

saveNameBtn.onclick = ()=>{ setUsername(usernameEl.value.trim()); usernameEl.value=''; };
changeNameBtn.onclick = ()=>{ usernameEl.focus(); };

/* Message sending */
sendBtn.onclick = sendMessage;
messageInput.onkeypress = e=>{ if(e.key==='Enter') sendMessage(); };

/* Fetch IP just for reference (can be displayed or logged) */
async function fetchIP(){
  try{ const r=await fetch('https://api.ipify.org?format=json'); const j=await r.json(); return j.ip||'unknown'; }
  catch{return 'unknown'; }
}

/* Realtime updates */
supabase.from('messages').on('INSERT', payload=>{
  const row = payload.new;
  if(row.device_id===deviceId) return; // already shown via pending
  displayMessageRow(row);
}).subscribe();

supabase.from('messages').on('DELETE', payload=>{
  const id = payload.old.id;
  const domRow = chatEl.querySelector(`[data-id='${id}']`);
  if(domRow) domRow.remove();
  removeOwnedId(id);
}).subscribe();

/* Process pending messages when back online */
async function syncPending(){
  const pending = getPending();
  for(const p of pending){
    try{
      const {data,error} = await supabase.from('messages').insert([{username:p.username,message:p.message,device_id:deviceId,created_at:p.created_at}]).select().maybeSingle();
      if(data){ removePendingByMatch(p.username,p.message,p.created_at); if(data.id) addOwnedId(String(data.id)); displayMessageRow(data); }
    }catch(e){ console.warn('Pending sync failed',e); }
  }
}

/* Connectivity detection & auto-sync */
window.addEventListener('online', ()=>{ checkConnectivity(); syncPending(); });
window.addEventListener('offline', ()=>{ statusEl.textContent='Offline'; statusEl.className='offline'; });

/* Initialize */
(function init(){
  if(currentUsername) currentUsernameLabel.textContent='Username: '+currentUsername;
  updateAutoScrollBtn();
  checkConnectivity();
  loadMessages();
  syncPending();
})();
</script>
</body>
</html>

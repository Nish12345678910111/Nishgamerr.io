<script language=JavaScript> html='%3C%21doctype%20html%3E%0D%0A%3Chtml%20lang%3D%22en%22%3E%0D%0A%3Chead%3E%20%3C%2Fhead%3E%0D%0A%3Cbody%3E%20%3C%2Fbody%3E%0D%0A%3Chead%3E%20%3C%2Fhead%3E%0D%0A%3Cbody%3E%20%3C%2Fbody%3E%0D%0A%20%20%0D%0A%3Cmeta%20charset%3D%22utf-8%22%20%2F%3E%0D%0A%3Cmeta%20name%3D%22viewport%22%20content%3D%22width%3Ddevice-width%2Cinitial-scale%3D1%22%20%2F%3E%0D%0A%3Ctitle%3Emodern%20chat%20by%20Nishgamerr%3C%2Ftitle%3E%0D%0A%3Cscript%20type%3D%22module%22%20src%3D%22https%3A%2F%2Fcdn.jsdelivr.net%2Fnpm%2F%40supabase%2Fsupabase-js%402%2F%2Besm%22%3E%3C%2Fscript%3E%0D%0A%3Cstyle%3E%0D%0A%20%20body%7Bbackground%3A%23071127%3Bcolor%3A%23e6eef8%3Bfont-family%3AInter%2Csystem-ui%2C-apple-system%2CSegoe%20UI%2CRoboto%3Bdisplay%3Aflex%3Bjustify-content%3Acenter%3Bpadding%3A18px%7D%0D%0A%20%20.wrap%7Bwidth%3A100%25%3Bmax-width%3A720px%7D%0D%0A%20%20h1%2Ch2%7Bmargin%3A0%200%208px%200%3Bcolor%3A%2360a5fa%7D%0D%0A%20%20.top%7Bdisplay%3Aflex%3Bjustify-content%3Aspace-between%3Balign-items%3Acenter%3Bmargin-bottom%3A8px%3Bgap%3A8px%3Bflex-wrap%3Awrap%7D%0D%0A%20%20%23currentUsername%7Bcolor%3A%2394a3b8%3Bfont-size%3A0.95rem%3Bmargin-right%3A8px%7D%0D%0A%20%20%23username%7Bbackground%3A%230f1724%3Bcolor%3A%23e6eef8%3Bborder%3A1px%20solid%20%231f2937%3Bpadding%3A6px%208px%3Bborder-radius%3A6px%3Bwidth%3A48%25%3Bmax-width%3A320px%7D%0D%0A%20%20%23chat%7Bbackground%3A%23071127%3Bborder-radius%3A8px%3Bpadding%3A12px%3Bheight%3A420px%3Boverflow-y%3Aauto%3Bborder%3A1px%20solid%20%23132033%7D%0D%0A%0D%0A%20%20.message%7Bdisplay%3Aflex%3Bmargin-bottom%3A10px%3Bopacity%3A1%3Btransition%3Aopacity%20.5s%3Bwidth%3A100%25%7D%0D%0A%20%20.msg-content-bubble%7Bpadding%3A8px%2012px%3Bborder-radius%3A12px%3Bmax-width%3A80%25%3Bdisplay%3Aflex%3Bflex-direction%3Acolumn%3Bgap%3A4px%3Bposition%3Arelative%7D%0D%0A%20%20.my-message%7Bjustify-content%3Aflex-end%7D%0D%0A%20%20.other-message%7Bjustify-content%3Aflex-start%7D%0D%0A%20%20.my-message%20.msg-content-bubble%7Bbackground%3A%231d4ed8%3Bborder-bottom-right-radius%3A2px%7D%0D%0A%20%20.other-message%20.msg-content-bubble%7Bbackground%3A%231f2937%3Bborder-bottom-left-radius%3A2px%7D%0D%0A%20%20.message%5Bdata-sending%3D%22true%22%5D%20.msg-content-bubble%7Bopacity%3A.7%7D%0D%0A%20%20.username%7Bcolor%3A%23d1d5db%3Bfont-weight%3A700%3Bmargin-bottom%3A4px%3Bfont-size%3A.85rem%7D%0D%0A%20%20.my-message%20.username%7Bcolor%3A%23e0f2f1%7D%0D%0A%20%20.text%7Bcolor%3A%23e6eef8%3Bwhite-space%3Apre-wrap%3Bline-height%3A1.35%3Bfont-size%3A.98rem%3Bword-break%3Abreak-word%7D%0D%0A%0D%0A%20%20.bubble-footer%7Bdisplay%3Aflex%3Balign-items%3Acenter%3Bjustify-content%3Aflex-end%3Bgap%3A8px%3Bmargin-top%3A4px%3Bfont-size%3A.82rem%7D%0D%0A%20%20.ts%7Bcolor%3A%23d1ddff%3Bfont-size%3A.82rem%3Bwhite-space%3Anowrap%7D%0D%0A%20%20.other-message%20.ts%7Bcolor%3A%2394a3b8%7D%0D%0A%20%20.del1%7Bwidth%3A18px%3Bheight%3A18px%3Bline-height%3A1%3Bborder-radius%3A50%25%3Bborder%3Anone%3Bbackground%3A%23ef4444%3Bcolor%3A%23fff%3Bcursor%3Apointer%3Bdisplay%3Aflex%3Balign-items%3Acenter%3Bjustify-content%3Acenter%3Bpadding%3A0%3Bfont-weight%3A700%3Bfont-size%3A.8rem%3Btransition%3Abackground%20.2s%7D%0D%0A%20%20.del1%3Ahover%7Bbackground%3A%23dc2626%7D%0D%0A%20%20.pending-status%7Bcolor%3A%23fbbf24%3Bfont-size%3A.82rem%3Bwhite-space%3Anowrap%3Bmargin-left%3Aauto%3Bmargin-top%3A4px%7D%0D%0A%0D%0A%20%20%23messageArea%7Bdisplay%3Aflex%3Bflex-direction%3Acolumn%3Bgap%3A5px%3Bmargin-top%3A10px%7D%0D%0A%20%20%23controls%7Bdisplay%3Aflex%3Bgap%3A8px%7D%0D%0A%20%20%23messageInput%7Bflex%3A1%3Bpadding%3A10px%3Bborder-radius%3A8px%3Bbackground%3A%230f1724%3Bcolor%3A%23e6eef8%3Bborder%3A1px%20solid%20%231f2937%7D%0D%0A%20%20%23sendBtn%7Bpadding%3A10px%2014px%3Bbackground%3A%232563eb%3Bborder%3Anone%3Bborder-radius%3A8px%3Bcolor%3A%23fff%3Bcursor%3Apointer%7D%0D%0A%20%20.smallBtn%7Bpadding%3A6px%208px%3Bborder-radius%3A6px%3Bborder%3Anone%3Bbackground%3A%231f2937%3Bcolor%3A%23e6eef8%3Bcursor%3Apointer%3Bfont-size%3A.85rem%7D%0D%0A%20%20%23controls2%7Bdisplay%3Aflex%3Bgap%3A8px%3Balign-items%3Acenter%3Bmargin-top%3A8px%3Bflex-wrap%3Awrap%7D%0D%0A%20%20%23errorBox%7Bmargin-top%3A8px%3Bcolor%3A%23fecaca%3Bmin-height%3A1.2em%3Bwhite-space%3Apre-wrap%7D%0D%0A%20%20%23dbDot%7Bwidth%3A12px%3Bheight%3A12px%3Bborder-radius%3A50%25%3Bdisplay%3Ainline-block%3Bmargin-left%3A8px%3Bbackground%3A%23dc2626%7D%0D%0A%20%20%23modal%7Bposition%3Afixed%3Binset%3A0%3Bdisplay%3Anone%3Balign-items%3Acenter%3Bjustify-content%3Acenter%3Bbackground%3Argba%280%2C0%2C0%2C.6%29%3Bz-index%3A60%7D%0D%0A%20%20.card%7Bbackground%3A%23071127%3Bpadding%3A12px%3Bborder-radius%3A8px%3Bborder%3A1px%20solid%20%23132033%3Bwidth%3A420px%3Bmax-width%3A95%25%3Bcolor%3A%23e6eef8%7D%0D%0A%20%20.row%7Bdisplay%3Aflex%3Bflex-direction%3Acolumn%3Bgap%3A6px%3Bmargin-bottom%3A8px%7D%0D%0A%20%20.actions%7Bdisplay%3Aflex%3Bgap%3A8px%3Bjustify-content%3Aflex-end%7D%0D%0A%0D%0A%20%20%23inspectOverlay%7B%0D%0A%20%20%20%20position%3Afixed%3Btop%3A0%3Bleft%3A0%3Bwidth%3A100vw%3Bheight%3A100vh%3B%0D%0A%20%20%20%20background%3Argba%280%2C0%2C0%2C0.02%29%3Bz-index%3A2147483647%3B%0D%0A%20%20%20%20display%3Anone%3Bpointer-events%3Anone%3B%0D%0A%20%20%20%20user-select%3Anone%3B%0D%0A%20%20%7D%0D%0A%20%20%23inspectOverlay.show%7Bdisplay%3Ablock%7D%0D%0A%0D%0A%20%20%40media%20%28max-width%3A480px%29%7B%0D%0A%20%20%20%20%23chat%7Bheight%3A285px%7D%0D%0A%20%20%20%20%23username%7Bwidth%3A60%25%7D%0D%0A%20%20%20%20.del1%7Bwidth%3A16px%3Bheight%3A16px%3Bfont-size%3A.7rem%7D%0D%0A%20%20%20%20.card%7Bwidth%3A95%25%7D%0D%0A%20%20%7D%0D%0A%3C%2Fstyle%3E%0D%0A%3C%2Fhead%3E%0D%0A%3Cbody%3E%0D%0A%20%20%3Cdiv%20class%3D%22wrap%22%3E%0D%0A%20%20%20%20%3Cdiv%20style%3D%22display%3Aflex%3Bjustify-content%3Aspace-between%3Balign-items%3Acenter%3B%22%3E%0D%0A%20%20%20%20%20%20%3Ch2%3Emodern%20chat%20by%20Nishgamerr%3C%2Fh2%3E%0D%0A%20%20%20%20%20%20%3Cdiv%3E%3Cspan%20id%3D%22dbDot%22%20title%3D%22DB%20status%22%3E%3C%2Fspan%3E%3C%2Fdiv%3E%0D%0A%20%20%20%20%3C%2Fdiv%3E%0D%0A%0D%0A%20%20%20%20%3Cdiv%20class%3D%22top%22%3E%0D%0A%20%20%20%20%20%20%3Cdiv%20style%3D%22display%3Aflex%3Balign-items%3Acenter%3Bgap%3A6px%3Bflex-wrap%3Awrap%3B%22%3E%0D%0A%20%20%20%20%20%20%20%20%3Cspan%20id%3D%22currentUsername%22%3EUsername%3A%20Guest%3C%2Fspan%3E%0D%0A%20%20%20%20%20%20%20%20%3Cinput%20id%3D%22username%22%20placeholder%3D%22Enter%20username%22%20autocomplete%3D%22off%22%20%2F%3E%0D%0A%20%20%20%20%20%20%20%20%3Cbutton%20id%3D%22saveName%22%20class%3D%22smallBtn%22%3ESave%3C%2Fbutton%3E%0D%0A%20%20%20%20%20%20%3C%2Fdiv%3E%0D%0A%20%20%20%20%20%20%3Cdiv%20style%3D%22color%3A%2394a3b8%22%3EOld%20GUI%20%26%20Realtime%3C%2Fdiv%3E%0D%0A%20%20%20%20%3C%2Fdiv%3E%0D%0A%0D%0A%20%20%20%20%3Cdiv%20id%3D%22chat%22%20role%3D%22log%22%20aria-live%3D%22polite%22%3E%3C%2Fdiv%3E%0D%0A%0D%0A%20%20%20%20%3Cdiv%20id%3D%22messageArea%22%3E%0D%0A%20%20%20%20%20%20%3Cdiv%20id%3D%22controls%22%3E%0D%0A%20%20%20%20%20%20%20%20%3Cinput%20id%3D%22messageInput%22%20placeholder%3D%22Type%20a%20message%22%20%2F%3E%0D%0A%20%20%20%20%20%20%20%20%3Cbutton%20id%3D%22sendBtn%22%3ESend%3C%2Fbutton%3E%0D%0A%20%20%20%20%20%20%3C%2Fdiv%3E%0D%0A%20%20%20%20%3C%2Fdiv%3E%0D%0A%0D%0A%20%20%20%20%3Cdiv%20id%3D%22controls2%22%3E%0D%0A%20%20%20%20%20%20%3Cbutton%20id%3D%22autoScrollBtn%22%20class%3D%22smallBtn%22%3EAuto%20Scroll%3A%20ON%3C%2Fbutton%3E%0D%0A%20%20%20%20%20%20%3Cbutton%20id%3D%22deleteAllBtn%22%20class%3D%22smallBtn%22%3EDelete%20All%20Mine%3C%2Fbutton%3E%0D%0A%20%20%20%20%20%20%3Cbutton%20id%3D%22passwordBtn%22%20class%3D%22smallBtn%22%3EPassword%3C%2Fbutton%3E%0D%0A%20%20%20%20%3C%2Fdiv%3E%0D%0A%0D%0A%20%20%20%20%3Cdiv%20id%3D%22errorBox%22%3E%3C%2Fdiv%3E%0D%0A%20%20%3C%2Fdiv%3E%0D%0A%0D%0A%20%20%3C%21--%20Modal%20--%3E%0D%0A%20%20%3Cdiv%20id%3D%22modal%22%20aria-hidden%3D%22true%22%3E%0D%0A%20%20%20%20%3Cdiv%20class%3D%22card%22%20role%3D%22dialog%22%20aria-modal%3D%22true%22%3E%0D%0A%20%20%20%20%20%20%3Cdiv%20style%3D%22display%3Aflex%3Bjustify-content%3Aspace-between%3Balign-items%3Acenter%3B%22%3E%0D%0A%20%20%20%20%20%20%20%20%3Cstrong%20id%3D%22modalTitle%22%3EPassword%3C%2Fstrong%3E%0D%0A%20%20%20%20%20%20%20%20%3Cbutton%20id%3D%22modalClose%22%20class%3D%22smallBtn%22%3EClose%3C%2Fbutton%3E%0D%0A%20%20%20%20%20%20%3C%2Fdiv%3E%0D%0A%20%20%20%20%20%20%3Cdiv%20style%3D%22margin-top%3A8px%3B%22%3E%0D%0A%20%20%20%20%20%20%20%20%3Cdiv%20id%3D%22modalMsg%22%20style%3D%22color%3A%239aa3b2%3Bmargin-bottom%3A8px%22%3E%3C%2Fdiv%3E%0D%0A%0D%0A%20%20%20%20%20%20%20%20%3Cdiv%20id%3D%22loginForm%22%20style%3D%22display%3Anone%3B%22%3E%0D%0A%20%20%20%20%20%20%20%20%20%20%3Cdiv%20class%3D%22row%22%3E%3Clabel%20style%3D%22color%3A%239aa3b2%22%3EPassword%3C%2Flabel%3E%0D%0A%20%20%20%20%20%20%20%20%20%20%3Cinput%20id%3D%22loginPw%22%20type%3D%22password%22%20placeholder%3D%22Enter%20password%22%20style%3D%22width%3A100%25%3Bpadding%3A8px%3Bborder-radius%3A6px%3Bbackground%3A%230f1724%3Bborder%3A1px%20solid%20%231f2937%3Bcolor%3A%23e6eef8%22%2F%3E%3C%2Fdiv%3E%0D%0A%20%20%20%20%20%20%20%20%20%20%3Cdiv%20class%3D%22actions%22%3E%3Cbutton%20id%3D%22loginBtn%22%20class%3D%22smallBtn%22%3ELogin%3C%2Fbutton%3E%3C%2Fdiv%3E%0D%0A%20%20%20%20%20%20%20%20%3C%2Fdiv%3E%0D%0A%0D%0A%20%20%20%20%20%20%20%20%3Cdiv%20id%3D%22setForm%22%20style%3D%22display%3Anone%3B%22%3E%0D%0A%20%20%20%20%20%20%20%20%20%20%3Cdiv%20class%3D%22row%22%3E%3Clabel%20style%3D%22color%3A%239aa3b2%22%3ENew%20password%3C%2Flabel%3E%3Cinput%20id%3D%22setPw%22%20type%3D%22password%22%20placeholder%3D%22New%20password%22%20style%3D%22width%3A100%25%3Bpadding%3A8px%3Bborder-radius%3A6px%3Bbackground%3A%230f1724%3Bborder%3A1px%20solid%20%231f2937%3Bcolor%3A%23e6eef8%22%2F%3E%3C%2Fdiv%3E%0D%0A%20%20%20%20%20%20%20%20%20%20%3Cdiv%20class%3D%22row%22%3E%3Clabel%20style%3D%22color%3A%239aa3b2%22%3EConfirm%20password%3C%2Flabel%3E%3Cinput%20id%3D%22setPwConfirm%22%20type%3D%22password%22%20placeholder%3D%22Confirm%20password%22%20style%3D%22width%3A100%25%3Bpadding%3A8px%3Bborder-radius%3A6px%3Bbackground%3A%230f1724%3Bborder%3A1px%20solid%20%231f2937%3Bcolor%3A%23e6eef8%22%2F%3E%3C%2Fdiv%3E%0D%0A%20%20%20%20%20%20%20%20%20%20%3Cdiv%20class%3D%22actions%22%3E%3Cbutton%20id%3D%22setSaveBtn%22%20class%3D%22smallBtn%22%3ESave%3C%2Fbutton%3E%3Cbutton%20id%3D%22setSkipBtn%22%20class%3D%22smallBtn%22%3ESkip%20%28claim%20without%20password%29%3C%2Fbutton%3E%3C%2Fdiv%3E%0D%0A%20%20%20%20%20%20%20%20%3C%2Fdiv%3E%0D%0A%0D%0A%20%20%20%20%20%20%20%20%3Cdiv%20id%3D%22changeForm%22%20style%3D%22display%3Anone%3B%22%3E%0D%0A%20%20%20%20%20%20%20%20%20%20%3Cdiv%20class%3D%22row%22%3E%3Clabel%20style%3D%22color%3A%239aa3b2%22%3ECurrent%20password%3C%2Flabel%3E%3Cinput%20id%3D%22chgCurrent%22%20type%3D%22password%22%20placeholder%3D%22Current%20password%22%20style%3D%22width%3A100%25%3Bpadding%3A8px%3Bborder-radius%3A6px%3Bbackground%3A%230f1724%3Bborder%3A1px%20solid%20%231f2937%3Bcolor%3A%23e6eef8%22%2F%3E%3C%2Fdiv%3E%0D%0A%20%20%20%20%20%20%20%20%20%20%3Cdiv%20class%3D%22row%22%3E%3Clabel%20style%3D%22color%3A%239aa3b2%22%3ENew%20password%3C%2Flabel%3E%3Cinput%20id%3D%22chgNew%22%20type%3D%22password%22%20placeholder%3D%22New%20password%22%20style%3D%22width%3A100%25%3Bpadding%3A8px%3Bborder-radius%3A6px%3Bbackground%3A%230f1724%3Bborder%3A1px%20solid%20%231f2937%3Bcolor%3A%23e6eef8%22%2F%3E%3C%2Fdiv%3E%0D%0A%20%20%20%20%20%20%20%20%20%20%3Cdiv%20class%3D%22row%22%3E%3Clabel%20style%3D%22color%3A%239aa3b2%22%3EConfirm%20new%3C%2Flabel%3E%3Cinput%20id%3D%22chgConfirm%22%20type%3D%22password%22%20placeholder%3D%22Confirm%20new%22%20style%3D%22width%3A100%25%3Bpadding%3A8px%3Bborder-radius%3A6px%3Bbackground%3A%230f1724%3Bborder%3A1px%20solid%20%231f2937%3Bcolor%3A%23e6eef8%22%2F%3E%3C%2Fdiv%3E%0D%0A%20%20%20%20%20%20%20%20%20%20%3Cdiv%20class%3D%22actions%22%3E%3Cbutton%20id%3D%22chgSaveBtn%22%20class%3D%22smallBtn%22%3EChange%3C%2Fbutton%3E%3C%2Fdiv%3E%0D%0A%20%20%20%20%20%20%20%20%3C%2Fdiv%3E%0D%0A%20%20%20%20%20%20%3C%2Fdiv%3E%0D%0A%20%20%20%20%3C%2Fdiv%3E%0D%0A%20%20%3C%2Fdiv%3E%0D%0A%0D%0A%20%20%3C%21--%20Fake%20Inspect%20Overlay%20--%3E%0D%0A%20%20%3Cdiv%20id%3D%22inspectOverlay%22%3E%0D%0A%20%20%20%20%3Cpre%20id%3D%22sourceCode%22%20style%3D%22position%3Afixed%3Btop%3A0%3Bright%3A0%3Bbottom%3A0%3Bwidth%3A50%25%3Bbackground%3A%23111%3Bcolor%3A%230f0%3Bfont-family%3Amonospace%3Bfont-size%3A12px%3Boverflow%3Aauto%3Bpadding%3A10px%3Bpointer-events%3Aauto%3Buser-select%3Atext%3Bwhite-space%3Apre-wrap%3Bword-wrap%3Abreak-word%3Bline-height%3A1.4%3B%22%3E%0D%0A%20%20%20%20%3C%2Fpre%3E%0D%0A%20%20%3C%2Fdiv%3E%0D%0A%0D%0A%3Cscript%20type%3D%22module%22%3E%0D%0Aimport%20%7B%20createClient%20%7D%20from%20%27https%3A%2F%2Fcdn.jsdelivr.net%2Fnpm%2F%40supabase%2Fsupabase-js%402%2F%2Besm%27%3B%0D%0A%0D%0Aconst%20SUPABASE_URL%20%3D%20%27https%3A%2F%2Fxvnbxdcqmfsnnvbugasi.supabase.co%27%3B%0D%0Aconst%20SUPABASE_ANON_KEY%20%3D%20%27sb_publishable_OQbzgO3ZE6-6qDl1YT_fXA_LA5aM-f0%27%3B%0D%0Aconst%20supabase%20%3D%20createClient%28SUPABASE_URL%2C%20SUPABASE_ANON_KEY%2C%20%7B%20realtime%3A%20%7B%20timeout%3A%2015000%20%7D%20%7D%29%3B%0D%0A%0D%0A%2F%2A%20%3D%3D%3D%20DOM%20ELEMENTS%20%3D%3D%3D%20%2A%2F%0D%0Aconst%20chatEl%20%3D%20document.getElementById%28%27chat%27%29%3B%0D%0Aconst%20usernameEl%20%3D%20document.getElementById%28%27username%27%29%3B%0D%0Aconst%20currentUsernameLabel%20%3D%20document.getElementById%28%27currentUsername%27%29%3B%0D%0Aconst%20saveNameBtn%20%3D%20document.getElementById%28%27saveName%27%29%3B%0D%0Aconst%20deleteAllBtn%20%3D%20document.getElementById%28%27deleteAllBtn%27%29%3B%0D%0Aconst%20autoScrollBtn%20%3D%20document.getElementById%28%27autoScrollBtn%27%29%3B%0D%0Aconst%20sendBtn%20%3D%20document.getElementById%28%27sendBtn%27%29%3B%0D%0Aconst%20messageInput%20%3D%20document.getElementById%28%27messageInput%27%29%3B%0D%0Aconst%20errorBox%20%3D%20document.getElementById%28%27errorBox%27%29%3B%0D%0Aconst%20dbDot%20%3D%20document.getElementById%28%27dbDot%27%29%3B%0D%0Aconst%20passwordBtn%20%3D%20document.getElementById%28%27passwordBtn%27%29%3B%0D%0Aconst%20modal%20%3D%20document.getElementById%28%27modal%27%29%3B%0D%0Aconst%20modalTitle%20%3D%20document.getElementById%28%27modalTitle%27%29%3B%0D%0Aconst%20modalMsg%20%3D%20document.getElementById%28%27modalMsg%27%29%3B%0D%0Aconst%20loginForm%20%3D%20document.getElementById%28%27loginForm%27%29%3B%0D%0Aconst%20setForm%20%3D%20document.getElementById%28%27setForm%27%29%3B%0D%0Aconst%20changeForm%20%3D%20document.getElementById%28%27changeForm%27%29%3B%0D%0Aconst%20loginPw%20%3D%20document.getElementById%28%27loginPw%27%29%3B%0D%0Aconst%20loginBtn%20%3D%20document.getElementById%28%27loginBtn%27%29%3B%0D%0Aconst%20setPw%20%3D%20document.getElementById%28%27setPw%27%29%3B%0D%0Aconst%20setPwConfirm%20%3D%20document.getElementById%28%27setPwConfirm%27%29%3B%0D%0Aconst%20setSaveBtn%20%3D%20document.getElementById%28%27setSaveBtn%27%29%3B%0D%0Aconst%20setSkipBtn%20%3D%20document.getElementById%28%27setSkipBtn%27%29%3B%0D%0Aconst%20chgCurrent%20%3D%20document.getElementById%28%27chgCurrent%27%29%3B%0D%0Aconst%20chgNew%20%3D%20document.getElementById%28%27chgNew%27%29%3B%0D%0Aconst%20chgConfirm%20%3D%20document.getElementById%28%27chgConfirm%27%29%3B%0D%0Aconst%20chgSaveBtn%20%3D%20document.getElementById%28%27chgSaveBtn%27%29%3B%0D%0Aconst%20modalClose%20%3D%20document.getElementById%28%27modalClose%27%29%3B%0D%0Aconst%20inspectOverlay%20%3D%20document.getElementById%28%27inspectOverlay%27%29%3B%0D%0Aconst%20sourceCodeEl%20%3D%20document.getElementById%28%27sourceCode%27%29%3B%0D%0A%0D%0A%2F%2A%20%3D%3D%3D%20STATE%20%3D%3D%3D%20%2A%2F%0D%0Aconst%20DEVICE_KEY%20%3D%20%27chat_device_id_v5%27%3B%0D%0Alet%20deviceId%20%3D%20localStorage.getItem%28DEVICE_KEY%29%3B%0D%0Aif%20%28%21deviceId%29%20%7B%20deviceId%20%3D%20crypto.randomUUID%28%29%3B%20localStorage.setItem%28DEVICE_KEY%2C%20deviceId%29%3B%20%7D%0D%0A%0D%0Alet%20autoScroll%20%3D%20true%3B%0D%0AautoScrollBtn.textContent%20%3D%20%60Auto%20Scroll%3A%20%24%7BautoScroll%20%3F%20%27ON%27%20%3A%20%27OFF%27%7D%60%3B%0D%0Alet%20loggedAs%20%3D%20localStorage.getItem%28%27chat_logged_as%27%29%20%7C%7C%20null%3B%0D%0Alet%20cachedPublicIp%20%3D%20null%3B%0D%0A%20%20%0D%0A%2F%2A%20%3D%3D%3D%20HELPERS%20%3D%3D%3D%20%2A%2F%0D%0Afunction%20showError%28msg%2C%20persist%20%3D%20false%29%20%7B%20errorBox.textContent%20%3D%20msg%20%7C%7C%20%27%27%3B%20if%20%28msg%20%26%26%20%21persist%29%20setTimeout%28%28%29%20%3D%3E%20%7B%20if%20%28errorBox.textContent%20%3D%3D%3D%20msg%29%20errorBox.textContent%20%3D%20%27%27%3B%20%7D%2C%204000%29%3B%20%7D%0D%0Afunction%20fmtTime%28iso%29%20%7B%20try%20%7B%20return%20new%20Date%28iso%29.toLocaleString%28undefined%2C%20%7B%20year%3A%27numeric%27%2C%20month%3A%27numeric%27%2C%20day%3A%27numeric%27%2C%20hour%3A%27numeric%27%2C%20minute%3A%27numeric%27%2C%20second%3A%27numeric%27%2C%20hour12%3Atrue%20%7D%29%3B%20%7D%20catch%20%7B%20return%20%27%3F%3F%3A%3F%3F%27%3B%20%7D%20%7D%0D%0Aasync%20function%20sha256hex%28str%29%20%7B%20const%20enc%20%3D%20new%20TextEncoder%28%29%3B%20const%20data%20%3D%20enc.encode%28str%29%3B%20const%20h%20%3D%20await%20crypto.subtle.digest%28%27SHA-256%27%2C%20data%29%3B%20return%20Array.from%28new%20Uint8Array%28h%29%29.map%28b%20%3D%3E%20b.toString%2816%29.padStart%282%2C%270%27%29%29.join%28%27%27%29%3B%20%7D%0D%0Aasync%20function%20getPublicIp%28%29%20%7B%20try%20%7B%20const%20r%20%3D%20await%20fetch%28%27https%3A%2F%2Fapi.ipify.org%3Fformat%3Djson%27%29%3B%20const%20j%20%3D%20await%20r.json%28%29%3B%20return%20j.ip%20%7C%7C%20null%3B%20%7D%20catch%20%7B%20return%20null%3B%20%7D%20%7D%0D%0Afunction%20normName%28n%29%20%7B%20return%20String%28n%7C%7C%27%27%29.replace%28%2Fs%2B%2Fg%2C%20%27%27%29%3B%20%7D%0D%0A%0D%0A%2F%2A%20%3D%3D%3D%20RENDER%20MESSAGE%20%3D%3D%3D%20%2A%2F%0D%0Afunction%20renderRow%28row%2C%20isSending%20%3D%20false%29%20%7B%0D%0A%20%20if%20%28%21row%29%20return%3B%0D%0A%20%20const%20id%20%3D%20row.id%20%3F%3F%20null%3B%0D%0A%20%20const%20clientId%20%3D%20row.client_id%20%3F%3F%20null%3B%0D%0A%20%20if%20%28%28id%20%26%26%20chatEl.querySelector%28%60%5Bdata-id%3D%27%24%7Bid%7D%27%5D%60%29%29%20%7C%7C%20%28clientId%20%26%26%20chatEl.querySelector%28%60%5Bdata-client-id%3D%27%24%7BclientId%7D%27%5D%60%29%29%29%20return%3B%0D%0A%0D%0A%20%20const%20wrapper%20%3D%20document.createElement%28%27div%27%29%3B%20wrapper.className%20%3D%20%27message%27%3B%0D%0A%20%20if%20%28id%29%20wrapper.dataset.id%20%3D%20id%3B%0D%0A%20%20if%20%28clientId%29%20wrapper.dataset.clientId%20%3D%20clientId%3B%0D%0A%20%20if%20%28isSending%29%20wrapper.dataset.sending%20%3D%20%27true%27%3B%0D%0A%0D%0A%20%20const%20ownedByDevice%20%3D%20row.device_id%20%26%26%20String%28row.device_id%29%20%3D%3D%3D%20String%28deviceId%29%3B%0D%0A%20%20const%20ownedByLogin%20%3D%20loggedAs%20%26%26%20row.username%20%26%26%20String%28row.username%29%20%3D%3D%3D%20String%28loggedAs%29%3B%0D%0A%20%20const%20isMine%20%3D%20ownedByDevice%20%7C%7C%20ownedByLogin%3B%0D%0A%20%20wrapper.classList.add%28isMine%20%3F%20%27my-message%27%20%3A%20%27other-message%27%29%3B%0D%0A%0D%0A%20%20const%20bubble%20%3D%20document.createElement%28%27div%27%29%3B%20bubble.className%20%3D%20%27msg-content-bubble%27%3B%0D%0A%20%20const%20u%20%3D%20document.createElement%28%27div%27%29%3B%20u.className%20%3D%20%27username%27%3B%20u.textContent%20%3D%20row.username%20%7C%7C%20%27Guest%27%3B%0D%0A%20%20const%20t%20%3D%20document.createElement%28%27div%27%29%3B%20t.className%20%3D%20%27text%27%3B%20t.textContent%20%3D%20row.content%20%3F%3F%20row.message%20%3F%3F%20%27%27%3B%0D%0A%20%20bubble.appendChild%28u%29%3B%20bubble.appendChild%28t%29%3B%0D%0A%0D%0A%20%20const%20footer%20%3D%20document.createElement%28%27div%27%29%3B%20footer.className%20%3D%20%27bubble-footer%27%3B%0D%0A%20%20if%20%28%21isSending%29%20%7B%0D%0A%20%20%20%20const%20ts%20%3D%20document.createElement%28%27span%27%29%3B%20ts.className%20%3D%20%27ts%27%3B%20ts.textContent%20%3D%20fmtTime%28row.created_at%20%3F%3F%20new%20Date%28%29.toISOString%28%29%29%3B%0D%0A%20%20%20%20footer.appendChild%28ts%29%3B%0D%0A%20%20%20%20if%20%28ownedByDevice%20%7C%7C%20ownedByLogin%29%20%7B%0D%0A%20%20%20%20%20%20const%20del%20%3D%20document.createElement%28%27button%27%29%3B%20del.className%20%3D%20%27del1%27%3B%20del.textContent%20%3D%20%27%C3%97%27%3B%20del.title%20%3D%20%27Delete%20message%27%3B%0D%0A%20%20%20%20%20%20del.onclick%20%3D%20async%20e%20%3D%3E%20%7B%20e.stopPropagation%28%29%3B%20if%20%28%21id%29%20return%3B%20wrapper.remove%28%29%3B%0D%0A%20%20%20%20%20%20%20%20try%20%7B%0D%0A%20%20%20%20%20%20%20%20%20%20let%20%7B%20error%20%7D%20%3D%20await%20supabase.from%28%27messages%27%29.delete%28%29.eq%28%27id%27%2C%20id%29.eq%28%27device_id%27%2C%20deviceId%29%3B%0D%0A%20%20%20%20%20%20%20%20%20%20if%20%28error%20%26%26%20ownedByLogin%29%20%7B%20const%20%7B%20error%3A%20e2%20%7D%20%3D%20await%20supabase.from%28%27messages%27%29.delete%28%29.eq%28%27id%27%2C%20id%29.eq%28%27username%27%2C%20loggedAs%29%3B%20if%20%28e2%29%20throw%20e2%3B%20%7D%0D%0A%20%20%20%20%20%20%20%20%20%20else%20if%20%28error%29%20throw%20error%3B%0D%0A%20%20%20%20%20%20%20%20%7D%20catch%20%28err%29%20%7B%20console.error%28err%29%3B%20showError%28%27Delete%20failed%27%29%3B%20%7D%0D%0A%20%20%20%20%20%20%7D%3B%0D%0A%20%20%20%20%20%20footer.appendChild%28del%29%3B%0D%0A%20%20%20%20%7D%0D%0A%20%20%7D%20else%20%7B%0D%0A%20%20%20%20const%20pending%20%3D%20document.createElement%28%27div%27%29%3B%20pending.className%20%3D%20%27pending-status%27%3B%20pending.textContent%20%3D%20%27Sending...%27%3B%0D%0A%20%20%20%20footer.appendChild%28pending%29%3B%0D%0A%20%20%7D%0D%0A%20%20if%20%28isMine%20%26%26%20row.username%20%21%3D%3D%20%27Guest%27%29%20u.style.display%20%3D%20%27none%27%3B%0D%0A%20%20if%20%28footer.children.length%29%20bubble.appendChild%28footer%29%3B%0D%0A%20%20wrapper.appendChild%28bubble%29%3B%0D%0A%20%20chatEl.appendChild%28wrapper%29%3B%0D%0A%20%20if%20%28autoScroll%29%20chatEl.scrollTop%20%3D%20chatEl.scrollHeight%3B%0D%0A%7D%0D%0A%0D%0A%2F%2A%20%3D%3D%3D%20LOAD%20MESSAGES%20%3D%3D%3D%20%2A%2F%0D%0Aasync%20function%20loadMessages%28%29%20%7B%0D%0A%20%20if%20%28%21navigator.onLine%29%20%7B%20showError%28%27Network%20offline%20%E2%80%94%20cannot%20load%20messages%27%29%3B%20return%3B%20%7D%0D%0A%20%20try%20%7B%0D%0A%20%20%20%20const%20%7B%20data%2C%20error%20%7D%20%3D%20await%20supabase.from%28%27messages%27%29.select%28%27id%2C%20username%2C%20content%2C%20message%2C%20device_id%2C%20created_at%27%29.order%28%27created_at%27%2C%20%7B%20ascending%3A%20true%20%7D%29%3B%0D%0A%20%20%20%20if%20%28error%29%20%7B%20showError%28%27Failed%20to%20load%20messages%3A%20%27%20%2B%20%28error.message%7C%7Cerror.code%29%2C%20true%29%3B%20console.error%28error%29%3B%20return%3B%20%7D%0D%0A%20%20%20%20chatEl.innerHTML%20%3D%20%27%27%3B%0D%0A%20%20%20%20%28data%7C%7C%5B%5D%29.forEach%28r%20%3D%3E%20%7B%20if%20%28r.content%20%3D%3D%3D%20undefined%20%26%26%20r.message%20%21%3D%3D%20undefined%29%20r.content%20%3D%20r.message%3B%20renderRow%28r%29%3B%20%7D%29%3B%0D%0A%20%20%7D%20catch%20%28e%29%20%7B%20console.error%28e%29%3B%20showError%28%27Load%20failed%27%29%3B%20%7D%0D%0A%7D%0D%0A%0D%0A%2F%2A%20%3D%3D%3D%20USER%20IP%20HELPERS%20%3D%3D%3D%20%2A%2F%0D%0Aasync%20function%20getUserByUsername%28name%29%20%7B%0D%0A%20%20if%20%28%21name%29%20return%20null%3B%0D%0A%20%20try%20%7B%0D%0A%20%20%20%20const%20%7B%20data%2C%20error%20%7D%20%3D%20await%20supabase.from%28%27user_ips%27%29.select%28%27ip_address%2C%20password_hash%2C%20username%2C%20current_username%27%29.or%28%60username.eq.%24%7Bname%7D%2Ccurrent_username.eq.%24%7Bname%7D%60%29.limit%281%29%3B%0D%0A%20%20%20%20if%20%28error%29%20%7B%20console.warn%28error%29%3B%20return%20null%3B%20%7D%0D%0A%20%20%20%20return%20data%3F.%5B0%5D%20%3F%3F%20null%3B%0D%0A%20%20%7D%20catch%20%28e%29%20%7B%20console.warn%28e%29%3B%20return%20null%3B%20%7D%0D%0A%7D%0D%0Aasync%20function%20upsertUserIp%28%7B%20username%2C%20ip%2C%20device_ip%20%3D%20null%2C%20device_id%20%3D%20null%2C%20password_hash%20%3D%20undefined%20%7D%29%20%7B%0D%0A%20%20if%20%28%21username%20%7C%7C%20%21ip%29%20return%3B%0D%0A%20%20try%20%7B%0D%0A%20%20%20%20const%20%7B%20data%3A%20existing%2C%20error%3A%20selErr%20%7D%20%3D%20await%20supabase.from%28%27user_ips%27%29.select%28%27ip_address%2C%20password_hash%27%29.eq%28%27username%27%2C%20username%29.limit%281%29%3B%0D%0A%20%20%20%20if%20%28selErr%29%20%7B%20console.warn%28%27select%20error%27%2C%20selErr%29%3B%20return%3B%20%7D%0D%0A%20%20%20%20const%20payload%20%3D%20%7B%20username%2C%20current_username%3A%20username%2C%20device_ip%2C%20device_id%3A%20device_id%20%7C%7C%20deviceId%2C%20updated_at%3A%20new%20Date%28%29.toISOString%28%29%20%7D%3B%0D%0A%20%20%20%20const%20exists%20%3D%20existing%20%26%26%20existing.length%3B%0D%0A%20%20%20%20if%20%28exists%29%20%7B%0D%0A%20%20%20%20%20%20let%20ips%20%3D%20Array.isArray%28existing%5B0%5D.ip_address%29%20%3F%20existing%5B0%5D.ip_address%20%3A%20%28existing%5B0%5D.ip_address%20%3F%20%5Bexisting%5B0%5D.ip_address%5D%20%3A%20%5B%5D%29%3B%0D%0A%20%20%20%20%20%20if%20%28%21ips.includes%28ip%29%29%20ips.push%28ip%29%3B%0D%0A%20%20%20%20%20%20const%20upd%20%3D%20%7B%20...payload%2C%20ip_address%3A%20ips%2C%20password_hash%3A%20password_hash%20%21%3D%3D%20undefined%20%3F%20password_hash%20%3A%20existing%5B0%5D.password_hash%20%7D%3B%0D%0A%20%20%20%20%20%20const%20%7B%20error%20%7D%20%3D%20await%20supabase.from%28%27user_ips%27%29.update%28upd%29.eq%28%27username%27%2C%20username%29%3B%0D%0A%20%20%20%20%20%20if%20%28error%29%20console.error%28%27update%20error%27%2C%20error%29%3B%0D%0A%20%20%20%20%7D%20else%20%7B%0D%0A%20%20%20%20%20%20const%20ins%20%3D%20%7B%20...payload%2C%20ip_address%3A%20%5Bip%5D%2C%20password_hash%20%7D%3B%0D%0A%20%20%20%20%20%20const%20%7B%20error%20%7D%20%3D%20await%20supabase.from%28%27user_ips%27%29.insert%28%5Bins%5D%29%3B%0D%0A%20%20%20%20%20%20if%20%28error%29%20console.error%28%27insert%20error%27%2C%20error%29%3B%0D%0A%20%20%20%20%7D%0D%0A%20%20%7D%20catch%20%28e%29%20%7B%20console.error%28%27upsert%20error%27%2C%20e%29%3B%20showError%28%27Failed%20to%20log%20IP%20address.%27%2C%20true%29%3B%20%7D%0D%0A%7D%0D%0A%0D%0A%2F%2A%20%3D%3D%3D%20MODAL%20%3D%3D%3D%20%2A%2F%0D%0Afunction%20showModal%28mode%2C%20username%29%20%7B%0D%0A%20%20modal.style.display%20%3D%20%27flex%27%3B%20modal.setAttribute%28%27aria-hidden%27%2C%27false%27%29%3B%0D%0A%20%20modalTitle.textContent%20%3D%20mode%20%3D%3D%3D%20%27login%27%20%3F%20%60Login%20%E2%80%94%20%24%7Busername%7D%60%20%3A%20mode%20%3D%3D%3D%20%27set%27%20%3F%20%60Set%20password%20%E2%80%94%20%24%7Busername%7D%60%20%3A%20%60Change%20password%20%E2%80%94%20%24%7Busername%7D%60%3B%0D%0A%20%20modalMsg.textContent%20%3D%20mode%20%3D%3D%3D%20%27login%27%20%3F%20%27This%20username%20is%20protected.%20Enter%20password.%27%20%3A%20mode%20%3D%3D%3D%20%27set%27%20%3F%20%27Set%20a%20password%20to%20protect%20this%20username%20or%20Skip%20to%20claim%20without%20password.%27%20%3A%20%27Enter%20current%20password%20and%20new%20password.%27%3B%0D%0A%20%20loginForm.style.display%20%3D%20mode%20%3D%3D%3D%20%27login%27%20%3F%20%27block%27%20%3A%20%27none%27%3B%0D%0A%20%20setForm.style.display%20%3D%20mode%20%3D%3D%3D%20%27set%27%20%3F%20%27block%27%20%3A%20%27none%27%3B%0D%0A%20%20changeForm.style.display%20%3D%20mode%20%3D%3D%3D%20%27change%27%20%3F%20%27block%27%20%3A%20%27none%27%3B%0D%0A%20%20loginPw.value%20%3D%20setPw.value%20%3D%20setPwConfirm.value%20%3D%20chgCurrent.value%20%3D%20chgNew.value%20%3D%20chgConfirm.value%20%3D%20%27%27%3B%0D%0A%20%20modal.dataset.username%20%3D%20username%20%7C%7C%20%27%27%3B%0D%0A%20%20modal.dataset.mode%20%3D%20mode%20%7C%7C%20%27%27%3B%0D%0A%7D%0D%0Afunction%20closeModal%28%29%20%7B%20modal.style.display%20%3D%20%27none%27%3B%20modal.setAttribute%28%27aria-hidden%27%2C%27true%27%29%3B%20modal.dataset.username%20%3D%20modal.dataset.mode%20%3D%20%27%27%3B%20%7D%0D%0A%0D%0A%2F%2A%20%3D%3D%3D%20SAVE%20NAME%20%26%20PASSWORD%20%3D%3D%3D%20%2A%2F%0D%0AsaveNameBtn.addEventListener%28%27click%27%2C%20async%20%28%29%20%3D%3E%20%7B%0D%0A%20%20const%20raw%20%3D%20usernameEl.value%20%7C%7C%20%27%27%3B%0D%0A%20%20const%20name%20%3D%20normName%28raw%29%3B%0D%0A%20%20if%20%28%21name%29%20return%20showError%28%27Enter%20username%27%29%3B%0D%0A%20%20usernameEl.value%20%3D%20name%3B%0D%0A%20%20if%20%28loggedAs%20%26%26%20loggedAs%20%3D%3D%3D%20name%29%20%7B%20currentUsernameLabel.textContent%20%3D%20%27Username%3A%20%27%20%2B%20name%3B%20localStorage.setItem%28%27chatUsername%27%2C%20name%29%3B%20showError%28%27Active%3A%20%27%20%2B%20name%29%3B%20return%3B%20%7D%0D%0A%20%20const%20rec%20%3D%20await%20getUserByUsername%28name%29%3B%0D%0A%20%20if%20%28rec%20%26%26%20rec.password_hash%29%20%7B%0D%0A%20%20%20%20showModal%28%27login%27%2C%20name%29%3B%0D%0A%20%20%20%20const%20handler%20%3D%20async%20%28%29%20%3D%3E%20%7B%0D%0A%20%20%20%20%20%20const%20pw%20%3D%20loginPw.value.trim%28%29%3B%0D%0A%20%20%20%20%20%20if%20%28%21pw%29%20return%20showError%28%27Enter%20password%27%29%3B%0D%0A%20%20%20%20%20%20const%20hash%20%3D%20await%20sha256hex%28pw%29%3B%0D%0A%20%20%20%20%20%20const%20fresh%20%3D%20await%20getUserByUsername%28name%29%3B%0D%0A%20%20%20%20%20%20if%20%28%21fresh%20%7C%7C%20%21fresh.password_hash%29%20%7B%20showError%28%27Password%20removed%20%E2%80%94%20retry%27%29%3B%20closeModal%28%29%3B%20return%3B%20%7D%0D%0A%20%20%20%20%20%20if%20%28hash%20%3D%3D%3D%20fresh.password_hash%29%20%7B%0D%0A%20%20%20%20%20%20%20%20loggedAs%20%3D%20name%3B%20localStorage.setItem%28%27chat_logged_as%27%2C%20loggedAs%29%3B%0D%0A%20%20%20%20%20%20%20%20usernameEl.value%20%3D%20name%3B%20currentUsernameLabel.textContent%20%3D%20%27Username%3A%20%27%20%2B%20name%3B%0D%0A%20%20%20%20%20%20%20%20await%20upsertUserIp%28%7B%20username%3A%20name%2C%20ip%3A%20cachedPublicIp%7C%7C%28%27device-%27%2BdeviceId%29%2C%20device_id%3A%20deviceId%2C%20password_hash%3A%20fresh.password_hash%20%7D%29%3B%0D%0A%20%20%20%20%20%20%20%20closeModal%28%29%3B%20showError%28%27Logged%20in%20as%20%27%20%2B%20name%29%3B%20await%20loadMessages%28%29%3B%0D%0A%20%20%20%20%20%20%7D%20else%20showError%28%27Wrong%20password%27%2C%20true%29%3B%0D%0A%20%20%20%20%7D%3B%0D%0A%20%20%20%20loginBtn.onclick%20%3D%20null%3B%20loginBtn.onclick%20%3D%20handler%3B%0D%0A%20%20%20%20return%3B%0D%0A%20%20%7D%0D%0A%20%20showModal%28%27set%27%2C%20name%29%3B%0D%0A%20%20const%20setHandler%20%3D%20async%20%28%29%20%3D%3E%20%7B%0D%0A%20%20%20%20const%20p%20%3D%20setPw.value.trim%28%29%2C%20c%20%3D%20setPwConfirm.value.trim%28%29%3B%0D%0A%20%20%20%20const%20fresh%20%3D%20await%20getUserByUsername%28name%29%3B%0D%0A%20%20%20%20if%20%28fresh%20%26%26%20fresh.password_hash%29%20%7B%20showError%28%27A%20password%20was%20set%20while%20you%20were%20typing.%20Please%20login.%27%2C%20true%29%3B%20closeModal%28%29%3B%20return%3B%20%7D%0D%0A%20%20%20%20if%20%28%21p%29%20return%20showError%28%27Enter%20a%20password%20or%20Skip%20to%20claim%20without%20password%27%29%3B%0D%0A%20%20%20%20if%20%28p%20%21%3D%3D%20c%29%20return%20showError%28%27Passwords%20do%20not%20match%27%29%3B%0D%0A%20%20%20%20const%20h%20%3D%20await%20sha256hex%28p%29%3B%0D%0A%20%20%20%20try%20%7B%0D%0A%20%20%20%20%20%20const%20%7B%20data%3A%20existing%20%7D%20%3D%20await%20supabase.from%28%27user_ips%27%29.select%28%27id%2Cpassword_hash%27%29.or%28%60username.eq.%24%7Bname%7D%2Ccurrent_username.eq.%24%7Bname%7D%60%29.limit%281%29%3B%0D%0A%20%20%20%20%20%20if%20%28existing%3F.%5B0%5D%3F.password_hash%29%20%7B%20showError%28%27Another%20user%20set%20a%20password%20%E2%80%94%20please%20login%27%2C%20true%29%3B%20closeModal%28%29%3B%20return%3B%20%7D%0D%0A%20%20%20%20%20%20await%20upsertUserIp%28%7B%20username%3A%20name%2C%20ip%3A%20cachedPublicIp%7C%7C%28%27device-%27%2BdeviceId%29%2C%20device_id%3A%20deviceId%2C%20password_hash%3A%20h%20%7D%29%3B%0D%0A%20%20%20%20%20%20loggedAs%20%3D%20name%3B%20localStorage.setItem%28%27chat_logged_as%27%2C%20loggedAs%29%3B%0D%0A%20%20%20%20%20%20usernameEl.value%20%3D%20name%3B%20currentUsernameLabel.textContent%20%3D%20%27Username%3A%20%27%20%2B%20name%3B%0D%0A%20%20%20%20%20%20closeModal%28%29%3B%20showError%28%27Password%20set%20and%20claimed%3A%20%27%20%2B%20name%29%3B%20await%20loadMessages%28%29%3B%0D%0A%20%20%20%20%7D%20catch%20%28e%29%20%7B%20console.error%28e%29%3B%20showError%28%27Failed%20to%20set%20password%27%29%3B%20%7D%0D%0A%20%20%7D%3B%0D%0A%20%20setSaveBtn.onclick%20%3D%20null%3B%20setSaveBtn.onclick%20%3D%20setHandler%3B%0D%0A%20%20const%20skipHandler%20%3D%20async%20%28%29%20%3D%3E%20%7B%0D%0A%20%20%20%20const%20fresh%20%3D%20await%20getUserByUsername%28name%29%3B%0D%0A%20%20%20%20if%20%28fresh%20%26%26%20fresh.password_hash%29%20%7B%20showError%28%27A%20password%20exists%20now%20%E2%80%94%20please%20login%27%2C%20true%29%3B%20closeModal%28%29%3B%20return%3B%20%7D%0D%0A%20%20%20%20await%20upsertUserIp%28%7B%20username%3A%20name%2C%20ip%3A%20cachedPublicIp%7C%7C%28%27device-%27%2BdeviceId%29%2C%20device_id%3A%20deviceId%2C%20password_hash%3A%20null%20%7D%29%3B%0D%0A%20%20%20%20loggedAs%20%3D%20name%3B%20localStorage.setItem%28%27chat_logged_as%27%2C%20loggedAs%29%3B%0D%0A%20%20%20%20usernameEl.value%20%3D%20name%3B%20currentUsernameLabel.textContent%20%3D%20%27Username%3A%20%27%20%2B%20name%3B%0D%0A%20%20%20%20closeModal%28%29%3B%20showError%28%27Claimed%3A%20%27%20%2B%20name%29%3B%20await%20loadMessages%28%29%3B%0D%0A%20%20%7D%3B%0D%0A%20%20setSkipBtn.onclick%20%3D%20null%3B%20setSkipBtn.onclick%20%3D%20skipHandler%3B%0D%0A%7D%29%3B%0D%0A%0D%0ApasswordBtn.addEventListener%28%27click%27%2C%20async%20%28%29%20%3D%3E%20%7B%0D%0A%20%20const%20raw%20%3D%20usernameEl.value%20%7C%7C%20%27%27%3B%0D%0A%20%20const%20name%20%3D%20normName%28raw%29%20%7C%7C%20loggedAs%3B%0D%0A%20%20if%20%28%21name%29%20return%20showError%28%27Enter%20or%20select%20username%20first%27%29%3B%0D%0A%20%20usernameEl.value%20%3D%20name%3B%0D%0A%20%20const%20rec%20%3D%20await%20getUserByUsername%28name%29%3B%0D%0A%20%20if%20%28rec%20%26%26%20rec.password_hash%29%20%7B%0D%0A%20%20%20%20if%20%28loggedAs%20%26%26%20loggedAs%20%3D%3D%3D%20name%29%20%7B%0D%0A%20%20%20%20%20%20showModal%28%27change%27%2C%20name%29%3B%0D%0A%20%20%20%20%20%20const%20changeHandler%20%3D%20async%20%28%29%20%3D%3E%20%7B%0D%0A%20%20%20%20%20%20%20%20const%20cur%20%3D%20chgCurrent.value.trim%28%29%2C%20nw%20%3D%20chgNew.value.trim%28%29%2C%20conf%20%3D%20chgConfirm.value.trim%28%29%3B%0D%0A%20%20%20%20%20%20%20%20const%20fresh%20%3D%20await%20getUserByUsername%28name%29%3B%0D%0A%20%20%20%20%20%20%20%20if%20%28%21fresh%20%7C%7C%20%21fresh.password_hash%29%20%7B%20showError%28%27Password%20missing%3B%20cannot%20change.%27%29%3B%20closeModal%28%29%3B%20return%3B%20%7D%0D%0A%20%20%20%20%20%20%20%20if%20%28%21cur%20%7C%7C%20%21nw%29%20return%20showError%28%27Fill%20both%20fields%27%29%3B%0D%0A%20%20%20%20%20%20%20%20if%20%28nw%20%21%3D%3D%20conf%29%20return%20showError%28%27New%20passwords%20do%20not%20match%27%29%3B%0D%0A%20%20%20%20%20%20%20%20const%20curHash%20%3D%20await%20sha256hex%28cur%29%3B%0D%0A%20%20%20%20%20%20%20%20if%20%28curHash%20%21%3D%3D%20fresh.password_hash%29%20return%20showError%28%27Current%20password%20wrong%27%29%3B%0D%0A%20%20%20%20%20%20%20%20const%20newHash%20%3D%20await%20sha256hex%28nw%29%3B%0D%0A%20%20%20%20%20%20%20%20const%20%7B%20error%20%7D%20%3D%20await%20supabase.from%28%27user_ips%27%29.update%28%7B%20password_hash%3A%20newHash%20%7D%29.eq%28%27username%27%2C%20name%29%3B%0D%0A%20%20%20%20%20%20%20%20if%20%28error%29%20%7B%20console.error%28error%29%3B%20showError%28%27Change%20failed%27%29%3B%20return%3B%20%7D%0D%0A%20%20%20%20%20%20%20%20closeModal%28%29%3B%20showError%28%27Password%20changed%27%29%3B%0D%0A%20%20%20%20%20%20%7D%3B%0D%0A%20%20%20%20%20%20chgSaveBtn.onclick%20%3D%20null%3B%20chgSaveBtn.onclick%20%3D%20changeHandler%3B%0D%0A%20%20%20%20%20%20return%3B%0D%0A%20%20%20%20%7D%0D%0A%20%20%20%20showModal%28%27login%27%2C%20name%29%3B%0D%0A%20%20%20%20const%20loginHandler%20%3D%20async%20%28%29%20%3D%3E%20%7B%0D%0A%20%20%20%20%20%20const%20pw%20%3D%20loginPw.value.trim%28%29%3B%0D%0A%20%20%20%20%20%20if%20%28%21pw%29%20return%20showError%28%27Enter%20password%27%29%3B%0D%0A%20%20%20%20%20%20const%20hash%20%3D%20await%20sha256hex%28pw%29%3B%0D%0A%20%20%20%20%20%20const%20fresh%20%3D%20await%20getUserByUsername%28name%29%3B%0D%0A%20%20%20%20%20%20if%20%28%21fresh%20%7C%7C%20%21fresh.password_hash%29%20%7B%20showError%28%27Password%20removed%3B%20try%20again%27%29%3B%20closeModal%28%29%3B%20return%3B%20%7D%0D%0A%20%20%20%20%20%20if%20%28hash%20%3D%3D%3D%20fresh.password_hash%29%20%7B%0D%0A%20%20%20%20%20%20%20%20loggedAs%20%3D%20name%3B%20localStorage.setItem%28%27chat_logged_as%27%2C%20loggedAs%29%3B%0D%0A%20%20%20%20%20%20%20%20usernameEl.value%20%3D%20name%3B%20currentUsernameLabel.textContent%20%3D%20%27Username%3A%20%27%20%2B%20name%3B%0D%0A%20%20%20%20%20%20%20%20await%20upsertUserIp%28%7B%20username%3A%20name%2C%20ip%3A%20cachedPublicIp%7C%7C%28%27device-%27%2BdeviceId%29%2C%20device_id%3A%20deviceId%2C%20password_hash%3A%20fresh.password_hash%20%7D%29%3B%0D%0A%20%20%20%20%20%20%20%20closeModal%28%29%3B%20showError%28%27Logged%20in%20as%20%27%20%2B%20name%29%3B%20await%20loadMessages%28%29%3B%0D%0A%20%20%20%20%20%20%7D%20else%20showError%28%27Wrong%20password%27%2C%20true%29%3B%0D%0A%20%20%20%20%7D%3B%0D%0A%20%20%20%20loginBtn.onclick%20%3D%20null%3B%20loginBtn.onclick%20%3D%20loginHandler%3B%0D%0A%20%20%20%20return%3B%0D%0A%20%20%7D%0D%0A%20%20showModal%28%27set%27%2C%20name%29%3B%0D%0A%20%20const%20setHandler2%20%3D%20async%20%28%29%20%3D%3E%20%7B%0D%0A%20%20%20%20const%20p%20%3D%20setPw.value.trim%28%29%2C%20c%20%3D%20setPwConfirm.value.trim%28%29%3B%0D%0A%20%20%20%20const%20fresh%20%3D%20await%20getUserByUsername%28name%29%3B%0D%0A%20%20%20%20if%20%28fresh%20%26%26%20fresh.password_hash%29%20%7B%20showError%28%27A%20password%20exists%20now%20%E2%80%94%20please%20login%27%2C%20true%29%3B%20closeModal%28%29%3B%20return%3B%20%7D%0D%0A%20%20%20%20if%20%28%21p%29%20return%20showError%28%27Enter%20new%20password%20or%20Skip%27%29%3B%0D%0A%20%20%20%20if%20%28p%20%21%3D%3D%20c%29%20return%20showError%28%27Passwords%20do%20not%20match%27%29%3B%0D%0A%20%20%20%20const%20h%20%3D%20await%20sha256hex%28p%29%3B%0D%0A%20%20%20%20await%20upsertUserIp%28%7B%20username%3A%20name%2C%20ip%3A%20cachedPublicIp%7C%7C%28%27device-%27%2BdeviceId%29%2C%20device_id%3A%20deviceId%2C%20password_hash%3A%20h%20%7D%29%3B%0D%0A%20%20%20%20loggedAs%20%3D%20name%3B%20localStorage.setItem%28%27chat_logged_as%27%2C%20loggedAs%29%3B%0D%0A%20%20%20%20usernameEl.value%20%3D%20name%3B%20currentUsernameLabel.textContent%20%3D%20%27Username%3A%20%27%20%2B%20name%3B%0D%0A%20%20%20%20closeModal%28%29%3B%20showError%28%27Password%20set%20and%20claimed%27%29%3B%20await%20loadMessages%28%29%3B%0D%0A%20%20%7D%3B%0D%0A%20%20setSaveBtn.onclick%20%3D%20null%3B%20setSaveBtn.onclick%20%3D%20setHandler2%3B%0D%0A%20%20const%20skipHandler2%20%3D%20async%20%28%29%20%3D%3E%20%7B%0D%0A%20%20%20%20const%20fresh%20%3D%20await%20getUserByUsername%28name%29%3B%0D%0A%20%20%20%20if%20%28fresh%20%26%26%20fresh.password_hash%29%20%7B%20showError%28%27A%20password%20exists%20now%20%E2%80%94%20please%20login%27%2C%20true%29%3B%20closeModal%28%29%3B%20return%3B%20%7D%0D%0A%20%20%20%20await%20upsertUserIp%28%7B%20username%3A%20name%2C%20ip%3A%20cachedPublicIp%7C%7C%28%27device-%27%2BdeviceId%29%2C%20device_id%3A%20deviceId%2C%20password_hash%3A%20null%20%7D%29%3B%0D%0A%20%20%20%20loggedAs%20%3D%20name%3B%20localStorage.setItem%28%27chat_logged_as%27%2C%20loggedAs%29%3B%0D%0A%20%20%20%20usernameEl.value%20%3D%20name%3B%20currentUsernameLabel.textContent%20%3D%20%27Username%3A%20%27%20%2B%20name%3B%0D%0A%20%20%20%20closeModal%28%29%3B%20showError%28%27Claimed%20%27%20%2B%20name%29%3B%20await%20loadMessages%28%29%3B%0D%0A%20%20%7D%3B%0D%0A%20%20setSkipBtn.onclick%20%3D%20null%3B%20setSkipBtn.onclick%20%3D%20skipHandler2%3B%0D%0A%7D%29%3B%0D%0A%0D%0A%2F%2A%20%3D%3D%3D%20SEND%20MESSAGE%20%3D%3D%3D%20%2A%2F%0D%0Aasync%20function%20sendMessage%28%29%20%7B%0D%0A%20%20const%20txt%20%3D%20messageInput.value.trim%28%29%3B%0D%0A%20%20if%20%28%21txt%29%20return%3B%0D%0A%20%20if%20%28%21navigator.onLine%29%20%7B%20showError%28%27Network%20offline%20%E2%80%94%20cannot%20send%27%29%3B%20return%3B%20%7D%0D%0A%20%20messageInput.value%20%3D%20%27%27%3B%20showError%28%27%27%29%3B%0D%0A%20%20const%20finalName%20%3D%20normName%28usernameEl.value%29%20%7C%7C%20%27Guest%27%3B%0D%0A%20%20const%20clientId%20%3D%20crypto.randomUUID%28%29%3B%0D%0A%20%20const%20tempRow%20%3D%20%7B%20username%3A%20finalName%2C%20content%3A%20txt%2C%20device_id%3A%20deviceId%2C%20client_id%3A%20clientId%2C%20created_at%3A%20new%20Date%28%29.toISOString%28%29%20%7D%3B%0D%0A%20%20renderRow%28tempRow%2C%20true%29%3B%0D%0A%20%20%28async%20%28%29%20%3D%3E%20%7B%0D%0A%20%20%20%20const%20ipToUse%20%3D%20cachedPublicIp%20%7C%7C%20%28%27device-%27%2BdeviceId%29%3B%0D%0A%20%20%20%20try%20%7B%0D%0A%20%20%20%20%20%20const%20claimed%20%3D%20await%20getUserByUsername%28finalName%29%3B%0D%0A%20%20%20%20%20%20const%20protectedName%20%3D%20claimed%20%26%26%20claimed.password_hash%20%26%26%20%28%21loggedAs%20%7C%7C%20loggedAs%20%21%3D%3D%20finalName%29%3B%0D%0A%20%20%20%20%20%20if%20%28protectedName%29%20%7B%20showError%28%27Username%20is%20protected.%20Login%20%28Password%29%20first%20to%20send.%27%2C%20true%29%3B%20throw%20new%20Error%28%27protected%27%29%3B%20%7D%0D%0A%20%20%20%20%20%20const%20ph%20%3D%20claimed%20%3F%20claimed.password_hash%20%3A%20null%3B%0D%0A%20%20%20%20%20%20upsertUserIp%28%7B%20username%3A%20finalName%2C%20ip%3A%20ipToUse%2C%20device_id%3A%20deviceId%2C%20password_hash%3A%20ph%20%7D%29.catch%28%28%29%20%3D%3E%20%7B%7D%29%3B%0D%0A%20%20%20%20%20%20let%20%7B%20error%20%7D%20%3D%20await%20supabase.from%28%27messages%27%29.insert%28%5B%7B%20username%3A%20finalName%2C%20content%3A%20txt%2C%20device_id%3A%20deviceId%2C%20client_id%3A%20clientId%20%7D%5D%29%3B%0D%0A%20%20%20%20%20%20if%20%28error%20%26%26%20%2Fcolumn%20.%2Acontent%20.%2Adoes%20not%20exist%2Fi.test%28String%28error.message%7C%7C%27%27%29%29%29%20%7B%0D%0A%20%20%20%20%20%20%20%20const%20%7B%20error%3A%20e2%20%7D%20%3D%20await%20supabase.from%28%27messages%27%29.insert%28%5B%7B%20username%3A%20finalName%2C%20message%3A%20txt%2C%20device_id%3A%20deviceId%2C%20client_id%3A%20clientId%20%7D%5D%29%3B%0D%0A%20%20%20%20%20%20%20%20if%20%28e2%29%20throw%20e2%3B%0D%0A%20%20%20%20%20%20%7D%20else%20if%20%28error%29%20throw%20error%3B%0D%0A%20%20%20%20%7D%20catch%20%28e%29%20%7B%0D%0A%20%20%20%20%20%20console.error%28%27Send%20error%27%2C%20e%29%3B%0D%0A%20%20%20%20%20%20let%20msg%20%3D%20%27Send%20failed%3A%20Unknown%20error.%20Try%20saving%20your%20username%20first.%27%3B%0D%0A%20%20%20%20%20%20if%20%28%21navigator.onLine%29%20msg%20%3D%20%27Send%20failed%3A%20Network%20offline%27%3B%0D%0A%20%20%20%20%20%20else%20if%20%28e%20%26%26%20e.message%29%20msg%20%3D%20%27Send%20failed%3A%20%27%20%2B%20e.message%3B%0D%0A%20%20%20%20%20%20showError%28msg%2C%20true%29%3B%0D%0A%20%20%20%20%20%20const%20tempEl%20%3D%20chatEl.querySelector%28%60%5Bdata-client-id%3D%27%24%7BclientId%7D%27%5D%60%29%3B%0D%0A%20%20%20%20%20%20if%20%28tempEl%29%20%7B%0D%0A%20%20%20%20%20%20%20%20tempEl.dataset.sending%20%3D%20%27false%27%3B%0D%0A%20%20%20%20%20%20%20%20const%20pend%20%3D%20tempEl.querySelector%28%27.pending-status%27%29%3B%0D%0A%20%20%20%20%20%20%20%20if%20%28pend%29%20pend.textContent%20%3D%20%27Failed%27%3B%0D%0A%20%20%20%20%20%20%20%20setTimeout%28%28%29%20%3D%3E%20%7B%20tempEl.remove%28%29%3B%20if%20%28errorBox.textContent%20%3D%3D%3D%20msg%29%20showError%28%27%27%29%3B%20%7D%2C%205000%29%3B%0D%0A%20%20%20%20%20%20%7D%0D%0A%20%20%20%20%7D%0D%0A%20%20%7D%29%28%29%3B%0D%0A%7D%0D%0A%0D%0A%2F%2A%20%3D%3D%3D%20DELETE%20ALL%20MINE%20%3D%3D%3D%20%2A%2F%0D%0AdeleteAllBtn.addEventListener%28%27click%27%2C%20async%20%28%29%20%3D%3E%20%7B%0D%0A%20%20if%20%28%21confirm%28%27Delete%20ALL%20messages%20posted%20by%20this%20device%3F%27%29%29%20return%3B%0D%0A%20%20if%20%28%21confirm%28%27Final%20confirm%3A%20permanently%20delete%20all%20your%20device%20messages.%27%29%29%20return%3B%0D%0A%20%20try%20%7B%0D%0A%20%20%20%20const%20%7B%20error%20%7D%20%3D%20await%20supabase.from%28%27messages%27%29.delete%28%29.eq%28%27device_id%27%2C%20deviceId%29%3B%0D%0A%20%20%20%20if%20%28error%29%20%7B%20showError%28%27Delete-all%20failed%27%29%3B%20console.error%28error%29%3B%20return%3B%20%7D%0D%0A%20%20%20%20await%20loadMessages%28%29%3B%0D%0A%20%20%7D%20catch%20%28e%29%20%7B%20console.error%28e%29%3B%20showError%28%27Delete-all%20failed%27%29%3B%20%7D%0D%0A%7D%29%3B%0D%0A%0D%0A%2F%2A%20%3D%3D%3D%20DB%20PROBE%20%3D%3D%3D%20%2A%2F%0D%0Aasync%20function%20probeConnection%28%29%20%7B%0D%0A%20%20if%20%28%21navigator.onLine%29%20%7B%20dbDot.style.background%20%3D%20%27%23dc2626%27%3B%20dbDot.title%20%3D%20%27Network%20offline%27%3B%20showError%28%27Network%20offline%27%2C%20true%29%3B%20return%3B%20%7D%0D%0A%20%20try%20%7B%0D%0A%20%20%20%20const%20ctrl%20%3D%20new%20AbortController%28%29%3B%0D%0A%20%20%20%20const%20tid%20%3D%20setTimeout%28%28%29%20%3D%3E%20ctrl.abort%28%29%2C%205000%29%3B%0D%0A%20%20%20%20const%20r%20%3D%20await%20fetch%28%60%24%7BSUPABASE_URL%7D%2Frest%2Fv1%2Fmessages%3Fselect%3Did%26limit%3D1%60%2C%20%7B%20method%3A%20%27GET%27%2C%20headers%3A%20%7B%20%27apikey%27%3A%20SUPABASE_ANON_KEY%2C%20%27Authorization%27%3A%20%60Bearer%20%24%7BSUPABASE_ANON_KEY%7D%60%20%7D%2C%20signal%3A%20ctrl.signal%2C%20cache%3A%20%27no-store%27%20%7D%29%3B%0D%0A%20%20%20%20clearTimeout%28tid%29%3B%0D%0A%20%20%20%20if%20%28r.ok%29%20%7B%20dbDot.style.background%20%3D%20%27%23f59e0b%27%3B%20dbDot.title%20%3D%20%27REST%20API%20reachable%27%3B%20return%3B%20%7D%0D%0A%20%20%20%20dbDot.style.background%20%3D%20%27%23dc2626%27%3B%20dbDot.title%20%3D%20%60REST%20probe%20failed%3A%20%24%7Br.status%7D%60%3B%0D%0A%20%20%20%20if%20%28r.status%20%3D%3D%3D%20401%20%7C%7C%20r.status%20%3D%3D%3D%20403%29%20showError%28%60Supabase%20auth%20error%20%24%7Br.status%7D%3A%20check%20key%20%26%20RLS%60%2C%20true%29%3B%0D%0A%20%20%20%20else%20showError%28%60REST%20probe%20failed%20%24%7Br.status%7D%60%2C%20true%29%3B%0D%0A%20%20%7D%20catch%20%28e%29%20%7B%20dbDot.style.background%20%3D%20%27%23dc2626%27%3B%20dbDot.title%20%3D%20%27Cannot%20reach%20Supabase%20API%27%3B%20showError%28%27Cannot%20reach%20Supabase%20API%27%2C%20true%29%3B%20%7D%0D%0A%7D%0D%0A%0D%0A%2F%2A%20%3D%3D%3D%20REALTIME%20%3D%3D%3D%20%2A%2F%0D%0Alet%20channel%20%3D%20null%3B%0D%0Aasync%20function%20subscribeRealtime%28%29%20%7B%0D%0A%20%20try%20%7B%0D%0A%20%20%20%20if%20%28channel%29%20await%20supabase.removeChannel%28channel%29%3B%0D%0A%20%20%20%20channel%20%3D%20supabase.channel%28%27chat-%27%20%2B%20Date.now%28%29%29%0D%0A%20%20%20%20%20%20.on%28%27postgres_changes%27%2C%20%7B%20event%3A%20%27INSERT%27%2C%20schema%3A%20%27public%27%2C%20table%3A%20%27messages%27%20%7D%2C%20payload%20%3D%3E%20%7B%0D%0A%20%20%20%20%20%20%20%20const%20row%20%3D%20payload.new%3B%0D%0A%20%20%20%20%20%20%20%20if%20%28row.content%20%3D%3D%3D%20undefined%20%26%26%20row.message%20%21%3D%3D%20undefined%29%20row.content%20%3D%20row.message%3B%0D%0A%20%20%20%20%20%20%20%20if%20%28row.client_id%20%26%26%20String%28row.device_id%29%20%3D%3D%3D%20String%28deviceId%29%29%20%7B%0D%0A%20%20%20%20%20%20%20%20%20%20const%20tmp%20%3D%20chatEl.querySelector%28%60%5Bdata-client-id%3D%27%24%7Brow.client_id%7D%27%5D%60%29%3B%0D%0A%20%20%20%20%20%20%20%20%20%20if%20%28tmp%29%20tmp.remove%28%29%3B%0D%0A%20%20%20%20%20%20%20%20%7D%0D%0A%20%20%20%20%20%20%20%20renderRow%28row%29%3B%0D%0A%20%20%20%20%20%20%7D%29%0D%0A%20%20%20%20%20%20.on%28%27postgres_changes%27%2C%20%7B%20event%3A%20%27DELETE%27%2C%20schema%3A%20%27public%27%2C%20table%3A%20%27messages%27%20%7D%2C%20payload%20%3D%3E%20%7B%0D%0A%20%20%20%20%20%20%20%20const%20old%20%3D%20payload.old%3B%0D%0A%20%20%20%20%20%20%20%20if%20%28%21old%3F.id%29%20return%3B%0D%0A%20%20%20%20%20%20%20%20const%20el%20%3D%20chatEl.querySelector%28%60%5Bdata-id%3D%27%24%7Bold.id%7D%27%5D%60%29%3B%0D%0A%20%20%20%20%20%20%20%20if%20%28el%29%20el.remove%28%29%3B%0D%0A%20%20%20%20%20%20%7D%29%0D%0A%20%20%20%20%20%20.on%28%27postgres_changes%27%2C%20%7B%20event%3A%20%27UPDATE%27%2C%20schema%3A%20%27public%27%2C%20table%3A%20%27messages%27%20%7D%2C%20payload%20%3D%3E%20%7B%0D%0A%20%20%20%20%20%20%20%20const%20r%20%3D%20payload.new%3B%0D%0A%20%20%20%20%20%20%20%20if%20%28%21r%29%20return%3B%0D%0A%20%20%20%20%20%20%20%20const%20el%20%3D%20chatEl.querySelector%28%60%5Bdata-id%3D%27%24%7Br.id%7D%27%5D%60%29%3B%0D%0A%20%20%20%20%20%20%20%20if%20%28el%29%20%7B%0D%0A%20%20%20%20%20%20%20%20%20%20const%20txt%20%3D%20el.querySelector%28%27.text%27%29%3B%0D%0A%20%20%20%20%20%20%20%20%20%20if%20%28txt%29%20txt.textContent%20%3D%20r.content%20%3F%3F%20r.message%20%3F%3F%20%27%27%3B%0D%0A%20%20%20%20%20%20%20%20%20%20const%20usr%20%3D%20el.querySelector%28%27.username%27%29%3B%0D%0A%20%20%20%20%20%20%20%20%20%20if%20%28usr%29%20usr.textContent%20%3D%20r.username%20%3F%3F%20usr.textContent%3B%0D%0A%20%20%20%20%20%20%20%20%20%20const%20ts%20%3D%20el.querySelector%28%27.ts%27%29%3B%0D%0A%20%20%20%20%20%20%20%20%20%20if%20%28ts%29%20ts.textContent%20%3D%20fmtTime%28r.created_at%20%3F%3F%20new%20Date%28%29.toISOString%28%29%29%3B%0D%0A%20%20%20%20%20%20%20%20%7D%20else%20renderRow%28r%29%3B%0D%0A%20%20%20%20%20%20%7D%29%0D%0A%20%20%20%20%20%20.subscribe%28status%20%3D%3E%20%7B%0D%0A%20%20%20%20%20%20%20%20if%20%28status%20%3D%3D%3D%20%27SUBSCRIBED%27%29%20%7B%20dbDot.style.background%20%3D%20%27%2316a34a%27%3B%20dbDot.title%20%3D%20%27Realtime%20subscribed%27%3B%20%7D%0D%0A%20%20%20%20%20%20%20%20else%20%7B%20dbDot.style.background%20%3D%20%27%23f59e0b%27%3B%20dbDot.title%20%3D%20%27Realtime%20connecting%2Ffailed%3A%20%27%20%2B%20status%3B%20%7D%0D%0A%20%20%20%20%20%20%20%20if%20%28status%20%3D%3D%3D%20%27CHANNEL_ERROR%27%20%7C%7C%20status%20%3D%3D%3D%20%27TIMED_OUT%27%29%20probeConnection%28%29%3B%0D%0A%20%20%20%20%20%20%7D%29%3B%0D%0A%20%20%7D%20catch%20%28e%29%20%7B%20console.warn%28%27realtime%20error%27%2C%20e%29%3B%20dbDot.style.background%20%3D%20%27%23dc2626%27%3B%20showError%28%27Realtime%20failed%3B%20using%20polling%27%2C%20true%29%3B%20dbDot.title%20%3D%20%27Realtime%20subscription%20failed%27%3B%20%7D%0D%0A%7D%0D%0A%0D%0A%2F%2A%20%3D%3D%3D%20INIT%20%3D%3D%3D%20%2A%2F%0D%0AmodalClose.addEventListener%28%27click%27%2C%20closeModal%29%3B%0D%0AusernameEl.addEventListener%28%27input%27%2C%20e%20%3D%3E%20%7B%20usernameEl.value%20%3D%20normName%28usernameEl.value%29%3B%20%7D%29%3B%0D%0A%28async%20%28%29%20%3D%3E%20%7B%0D%0A%20%20try%20%7B%0D%0A%20%20%20%20const%20ip%20%3D%20await%20getPublicIp%28%29%3B%20cachedPublicIp%20%3D%20ip%3B%0D%0A%20%20%20%20const%20saved%20%3D%20localStorage.getItem%28%27chatUsername%27%29%20%7C%7C%20%27%27%3B%0D%0A%20%20%20%20if%20%28saved%29%20%7B%20usernameEl.value%20%3D%20saved%3B%20currentUsernameLabel.textContent%20%3D%20%27Username%3A%20%27%20%2B%20saved%3B%20%7D%0D%0A%20%20%20%20if%20%28localStorage.getItem%28%27chat_logged_as%27%29%29%20%7B%20loggedAs%20%3D%20localStorage.getItem%28%27chat_logged_as%27%29%3B%20currentUsernameLabel.textContent%20%3D%20%27Username%3A%20%27%20%2B%20loggedAs%3B%20usernameEl.value%20%3D%20loggedAs%3B%20%7D%0D%0A%20%20%20%20if%20%28ip%29%20%7B%0D%0A%20%20%20%20%20%20try%20%7B%0D%0A%20%20%20%20%20%20%20%20const%20%7B%20data%20%7D%20%3D%20await%20supabase.from%28%27user_ips%27%29.select%28%27%2A%27%29.or%28%60ip_address.cs.%7B%22%24%7Bip%7D%22%7D%2Cdevice_ip.eq.%24%7Bip%7D%60%29.limit%281%29%3B%0D%0A%20%20%20%20%20%20%20%20const%20r%20%3D%20data%3F.%5B0%5D%3B%0D%0A%20%20%20%20%20%20%20%20if%20%28r%20%26%26%20%28r.username%20%7C%7C%20r.current_username%29%29%20%7B%0D%0A%20%20%20%20%20%20%20%20%20%20const%20name%20%3D%20r.username%20%7C%7C%20r.current_username%3B%0D%0A%20%20%20%20%20%20%20%20%20%20if%20%28r.password_hash%29%20%7B%0D%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20%28String%28r.device_id%29%20%3D%3D%3D%20String%28deviceId%29%20%7C%7C%20loggedAs%20%3D%3D%3D%20name%29%20%7B%20usernameEl.value%20%3D%20name%3B%20currentUsernameLabel.textContent%20%3D%20%27Username%3A%20%27%20%2B%20name%3B%20localStorage.setItem%28%27chatUsername%27%2C%20name%29%3B%20%7D%0D%0A%20%20%20%20%20%20%20%20%20%20%7D%20else%20%7B%20usernameEl.value%20%3D%20name%3B%20currentUsernameLabel.textContent%20%3D%20%27Username%3A%20%27%20%2B%20name%3B%20localStorage.setItem%28%27chatUsername%27%2C%20name%29%3B%20%7D%0D%0A%20%20%20%20%20%20%20%20%7D%0D%0A%20%20%20%20%20%20%7D%20catch%20%28e%29%20%7B%7D%0D%0A%20%20%20%20%7D%0D%0A%20%20%7D%20catch%20%28e%29%20%7B%20console.warn%28%27init%20mapping%20fail%27%2C%20e%29%3B%20%7D%0D%0A%20%20probeConnection%28%29%3B%20await%20loadMessages%28%29%3B%20await%20subscribeRealtime%28%29%3B%20setInterval%28probeConnection%2C%2010000%29%3B%0D%0A%20%20sendBtn.addEventListener%28%27click%27%2C%20sendMessage%29%3B%0D%0A%20%20messageInput.addEventListener%28%27keydown%27%2C%20e%20%3D%3E%20%7B%20if%20%28e.key%20%3D%3D%3D%20%27Enter%27%20%26%26%20%21e.shiftKey%29%20%7B%20e.preventDefault%28%29%3B%20sendMessage%28%29%3B%20%7D%20%7D%29%3B%0D%0A%20%20autoScrollBtn.addEventListener%28%27click%27%2C%20%28%29%20%3D%3E%20%7B%20autoScroll%20%3D%20%21autoScroll%3B%20autoScrollBtn.textContent%20%3D%20%60Auto%20Scroll%3A%20%24%7BautoScroll%20%3F%20%27ON%27%20%3A%20%27OFF%27%7D%60%3B%20%7D%29%3B%0D%0A%7D%29%28%29%3B%0D%0A%3C%2Fscript%3E%0D%0A%3C%2Fbody%3E%0D%0A%3C%2Fhtml%3E';d=unescape(html);document.write(d);</script>

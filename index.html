<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Realtime Chat</title>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<style>
body{font-family:sans-serif;background:#121212;color:#eee;margin:0;display:flex;flex-direction:column;height:100vh}
#header{background:#222;padding:8px;text-align:center}
#status{font-weight:bold;margin-left:6px}
#chat{flex:1;overflow-y:auto;padding:10px}
.msg{margin:6px 0;padding:6px 10px;background:#1e1e1e;border-radius:10px}
.msg.mine{background:#29403b}
.controls{display:flex;padding:8px;gap:5px;background:#222}
input,button{padding:8px;border:none;border-radius:6px}
input{flex:1;background:#1e1e1e;color:#fff}
button{background:#4b6bff;color:white;cursor:pointer}
button:hover{background:#698bff}
.topBtns{display:flex;justify-content:center;gap:8px;padding:5px;background:#181818}
.online{color:#0f0}.offline{color:#f33}
</style>
</head>
<body>
<div id="header">Realtime Chat | Status: <span id="status" class="offline">Offline</span></div>
<div class="topBtns">
  <button id="toggleScroll">AutoScroll ON</button>
  <button id="deleteMine">Delete All Mine</button>
</div>
<div id="chat"></div>
<div class="controls">
  <input id="username" placeholder="Username">
  <input id="message" placeholder="Type a message">
  <button id="send">Send</button>
</div>

<script>
const supabaseUrl='https://latrynkftllkwkesmohg.supabase.co';
const supabaseKey='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxhdHJ5bmtmdGxsa3drZXNtb2hnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA4OTg5MzgsImV4cCI6MjA3NjQ3NDkzOH0.DBxC0tKd5axpldXK6CbKCR2rNqva-aerd_f985LTg0k';
const supabase = supabase.createClient(supabaseUrl,supabaseKey);
const chat=document.getElementById('chat');
const msgInput=document.getElementById('message');
const nameInput=document.getElementById('username');
const sendBtn=document.getElementById('send');
const delMine=document.getElementById('deleteMine');
const statusEl=document.getElementById('status');
const toggleBtn=document.getElementById('toggleScroll');
let autoScroll=true;
let username=localStorage.getItem('username')||'';
if(username) nameInput.value=username;

/* connectivity */
async function checkConnectivity(){
 try{
   const {error}=await supabase.from('messages').select('id').limit(1);
   if(error){statusEl.textContent='Offline';statusEl.className='offline';}
   else{statusEl.textContent='Online';statusEl.className='online';}
 }catch{statusEl.textContent='Offline';statusEl.className='offline';}
}
setInterval(checkConnectivity,10000);checkConnectivity();

/* load messages */
async function loadMessages(){
 const {data,error}=await supabase.from('messages').select('*').order('id',{ascending:true});
 if(error){chat.innerHTML='<p>Failed to load messages</p>';return;}
 chat.innerHTML='';
 data.forEach(addMessage);
 if(autoScroll) chat.scrollTop=chat.scrollHeight;
}

/* add message element */
function addMessage(m){
 const div=document.createElement('div');
 div.className='msg'+(m.username===username?' mine':'');
 div.innerHTML=`<b>${m.username}</b>: ${m.message}
 <small style="opacity:.6;float:right">${new Date(m.created_at).toLocaleTimeString()}</small>`;
 if(m.username===username){
   const del=document.createElement('button');
   del.textContent='ðŸ—‘';
   del.style.float='right';del.style.marginLeft='5px';del.onclick=()=>deleteMessage(m.id);
   div.appendChild(del);
 }
 chat.appendChild(div);
 if(autoScroll) chat.scrollTop=chat.scrollHeight;
}

/* send message */
async function sendMessage(){
 const msg=msgInput.value.trim();
 username=nameInput.value.trim()||'Anon';
 if(!msg)return;
 localStorage.setItem('username',username);
 const {error}=await supabase.from('messages')
   .insert([{username,message:msg}],{headers:{username}});
 if(!error) msgInput.value='';
}
sendBtn.onclick=sendMessage;
msgInput.addEventListener('keypress',e=>{if(e.key==='Enter')sendMessage();});

/* delete one */
async function deleteMessage(id){
 const {error}=await supabase.from('messages').delete().eq('id',id).eq('username',username);
 if(error) console.error(error);
}

/* delete all mine */
delMine.onclick=async()=>{
 if(!confirm('Delete all your messages?'))return;
 const {error}=await supabase.from('messages').delete().eq('username',username);
 if(error)alert('Delete failed');
}

/* toggle scroll */
toggleBtn.onclick=()=>{
 autoScroll=!autoScroll;
 toggleBtn.textContent=autoScroll?'AutoScroll ON':'AutoScroll OFF';
};

/* realtime */
supabase.channel('room')
  .on('postgres_changes',{event:'INSERT',schema:'public',table:'messages'},
    payload=>{addMessage(payload.new);})
  .on('postgres_changes',{event:'DELETE',schema:'public',table:'messages'},
    payload=>{loadMessages();})
  .subscribe();

/* init */
loadMessages();
</script>
</body>
</html>

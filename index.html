<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Modern Chat</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
body {
  background: #111;
  color: #fff;
  font-family: Arial, sans-serif;
  margin: 0;
  display: flex;
  flex-direction: column;
  height: 100vh;
}
header {
  background: #222;
  padding: 10px;
  text-align: center;
  font-weight: bold;
  color: #0f0;
}
#status {
  font-size: 14px;
  margin-top: 4px;
}
#chat {
  flex: 1;
  overflow-y: auto;
  padding: 10px;
  display: flex;
  flex-direction: column;
}
.message {
  background: #1e1e1e;
  padding: 6px 10px;
  margin: 5px 0;
  border-radius: 8px;
  max-width: 80%;
  word-break: break-word;
  font-size: 15px;
  line-height: 1.3;
  display: flex;
  flex-direction: column;
}
.mine {
  background: #0044cc;
  align-self: flex-end;
}
.other {
  background: #333;
  align-self: flex-start;
}
.meta {
  font-size: 11px;
  color: #aaa;
  margin-bottom: 2px;
}
#inputBox {
  display: flex;
  padding: 10px;
  background: #222;
}
#msg {
  flex: 1;
  padding: 8px;
  border: none;
  outline: none;
  border-radius: 6px;
}
#sendBtn {
  margin-left: 10px;
  padding: 8px 16px;
  border: none;
  background: #0f0;
  color: #000;
  font-weight: bold;
  border-radius: 6px;
  cursor: pointer;
}
#usernameBox {
  padding: 10px;
  background: #222;
  display: flex;
  justify-content: center;
  gap: 10px;
}
#usernameInput {
  padding: 8px;
  border-radius: 6px;
  border: none;
  outline: none;
}
#saveUsername {
  padding: 8px 12px;
  background: #0f0;
  color: #000;
  border: none;
  border-radius: 6px;
  cursor: pointer;
}
.online {
  color: #0f0;
}
.offline {
  color: #f33;
}
</style>
</head>
<body>
<header>
  Modern Chat
  <div id="status" class="offline">Checking...</div>
</header>

<div id="usernameBox">
  <input type="text" id="usernameInput" placeholder="Enter username">
  <button id="saveUsername">Save</button>
</div>

<div id="chat"></div>

<div id="inputBox">
  <input type="text" id="msg" placeholder="Type a message..." disabled>
  <button id="sendBtn" disabled>Send</button>
</div>

<script>
const SUPABASE_URL = 'https://latrynkftllkwkesmohg.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxhdHJ5bmtmdGxsa3drZXNtb2hnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA4OTg5MzgsImV4cCI6MjA3NjQ3NDkzOH0.DBxC0tKd5axpldXK6CbKCR2rNqva-aerd_f985LTg0k';
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const chat = document.getElementById('chat');
const msgInput = document.getElementById('msg');
const sendBtn = document.getElementById('sendBtn');
const usernameBox = document.getElementById('usernameBox');
const usernameInput = document.getElementById('usernameInput');
const saveUsername = document.getElementById('saveUsername');
const statusEl = document.getElementById('status');

let username = localStorage.getItem('username');
let ipAddr = 'unknown';

/* Fetch IP */
async function fetchIP() {
  try {
    const r = await fetch('https://api.ipify.org?format=json');
    const j = await r.json();
    ipAddr = j.ip || 'unknown';
  } catch {
    ipAddr = 'unknown';
  }
}

/* Connectivity */
async function checkConnectivity() {
  try {
    const { error } = await supabase.from('todos').select('id').limit(1);
    if (error) throw error;
    statusEl.textContent = 'Online';
    statusEl.className = 'online';
  } catch {
    statusEl.textContent = 'Offline';
    statusEl.className = 'offline';
  }
}

if (supabase.realtime?.connection) {
  supabase.realtime.connection.on('open', () => {
    statusEl.textContent = 'Online';
    statusEl.className = 'online';
  });
  supabase.realtime.connection.on('close', () => {
    statusEl.textContent = 'Offline';
    statusEl.className = 'offline';
  });
  supabase.realtime.connection.on('error', () => {
    statusEl.textContent = 'Offline';
    statusEl.className = 'offline';
  });
}

/* Load Messages */
async function loadMessages() {
  chat.innerHTML = '';
  const { data } = await supabase.from('messages').select('*').order('id');
  if (data) data.forEach(addMessage);
}

/* Add Message */
function addMessage(m) {
  const div = document.createElement('div');
  div.className = 'message ' + (m.username === username ? 'mine' : 'other');
  
  const meta = document.createElement('div');
  meta.className = 'meta';
  const time = new Date(m.created_at || Date.now()).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  meta.textContent = `[${time}] ${m.username}`;
  
  const text = document.createElement('div');
  text.textContent = m.content;
  
  div.appendChild(meta);
  div.appendChild(text);
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}

/* Send Message */
async function sendMessage() {
  const text = msgInput.value.trim();
  if (!text) return;
  await supabase.from('messages').insert([{ username, content: text, ip: ipAddr }]);
  msgInput.value = '';
}

/* Username Setup */
saveUsername.onclick = () => {
  const name = usernameInput.value.trim();
  if (!name) return alert('Enter a username first!');
  username = name;
  localStorage.setItem('username', name);
  usernameBox.style.display = 'none';
  msgInput.disabled = false;
  sendBtn.disabled = false;
};

/* Realtime */
supabase
  .channel('messages-channel')
  .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' },
    payload => addMessage(payload.new)
  ).subscribe();

/* Event Listeners */
sendBtn.onclick = sendMessage;
msgInput.addEventListener('keydown', e => { if (e.key === 'Enter') sendMessage(); });

/* Init */
(async () => {
  await fetchIP();
  await checkConnectivity();
  if (username) {
    usernameBox.style.display = 'none';
    msgInput.disabled = false;
    sendBtn.disabled = false;
  }
  loadMessages();
  setInterval(checkConnectivity, 10000);
})();
</script>
</body>
</html>

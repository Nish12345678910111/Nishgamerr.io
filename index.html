<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chat App — Old GUI Fixed</title>
<script type="module" src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm"></script>
<style>
body { background:#0b1220; color:#e6eef8; font-family:Inter,system-ui,sans-serif; display:flex; justify-content:center; padding:18px;}
.wrap { width:100%; max-width:720px;}
h1 { text-align:center; color:#60a5fa; margin-bottom:10px;}
.top { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; gap:8px;}
#currentUsername { color:#94a3b8; font-size:0.95rem; margin-bottom:4px;}
#username { background:#0f1724; color:#e6eef8; border:1px solid #1f2937; padding:6px 8px; border-radius:6px; width:48%;}
#prevUsernames { background:#0f1724; color:#e6eef8; border:1px solid #1f2937; padding:6px 8px; border-radius:6px; width:48%; margin-top:4px;}
#chat { background:#071127; border-radius:8px; padding:12px; height:420px; overflow-y:auto; border:1px solid #132033; margin-bottom:8px;}
.message { margin-bottom:10px;}
.username { color:#60a5fa; font-weight:700; margin-right:8px;}
.ts { color:#94a3b8; font-size:0.82rem; margin-left:8px;}
#controls { display:flex; gap:8px; margin-top:4px;}
#messageInput { flex:1; padding:10px; border-radius:8px; background:#0f1724; color:#e6eef8; border:1px solid #1f2937;}
button { border:none; border-radius:6px; cursor:pointer; }
#sendBtn { background:#2563eb; color:white; padding:10px 14px;}
#autoScrollBtn { background:#facc15; color:#1f2937; padding:8px 12px; font-size:0.85rem;}
#deleteAllBtn { background:#dc2626; color:white; padding:8px 12px; font-size:0.85rem;}
.pending { opacity:0.6; font-style:italic;}
#status { position:fixed; right:14px; top:14px; padding:6px 10px; border-radius:8px; font-weight:700;}
.online { background:#16a34a; color:#052e0b; } .offline { background:#dc2626; color:#2b0202; }
#nameMsg { color:#fb7185; font-size:0.9rem; margin-top:4px; min-height:1.2em;}
</style>
</head>
<body>
<div id="status" class="offline">Offline</div>
<div class="wrap">
  <h1>Chat App — Old GUI</h1>

  <div class="top">
    <div>
      <span id="currentUsername">Username: Guest</span><br>
      <input id="username" placeholder="Enter username">
      <button id="saveName">Save</button>
      <select id="prevUsernames" style="display:none;">
        <option value="">Select Previous Username</option>
      </select>
      <button id="autoScrollBtn">Auto-Scroll: On</button>
      <button id="deleteAllBtn">Delete All My Messages</button>
      <div id="nameMsg"></div>
    </div>
    <div style="color:#94a3b8">Old GUI • Realtime</div>
  </div>

  <div id="chat" role="log" aria-live="polite"></div>

  <div id="controls">
    <input id="messageInput" placeholder="Type a message">
    <button id="sendBtn">Send</button>
  </div>
</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

const SUPABASE_URL = 'https://latrynkftllkwkesmohg.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxhdHJ5bmtmdGxsa3drZXNtb2hnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA4OTg5MzgsImV4cCI6MjA3NjQ3NDkzOH0.DBxC0tKd5axpldXK6CbKCR2rNqva-aerd_f985LTg0k';

const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const chatEl = document.getElementById('chat');
const usernameEl = document.getElementById('username');
const saveNameBtn = document.getElementById('saveName');
const prevUsernamesEl = document.getElementById('prevUsernames');
const currentUsernameLabel = document.getElementById('currentUsername');
const messageInput = document.getElementById('messageInput');
const sendBtn = document.getElementById('sendBtn');
const statusEl = document.getElementById('status');
const autoScrollBtn = document.getElementById('autoScrollBtn');
const deleteAllBtn = document.getElementById('deleteAllBtn');
const nameMsgEl = document.getElementById('nameMsg');

let currentUsername = localStorage.getItem('chatUsername') || 'Guest';
let autoScroll = true;

// --- INDEXEDDB SETUP ---
const dbName = 'ChatApp';
const storeName = 'usernames';

async function initIndexedDB() {
  return new Promise((resolve, reject) => {
    const request = indexedDB.open(dbName, 1);
    request.onupgradeneeded = (event) => {
      const db = event.target.result;
      db.createObjectStore(storeName, { keyPath: 'username' });
    };
    request.onsuccess = (event) => {
      resolve(event.target.result);
    };
    request.onerror = (event) => {
      reject(event.target.error);
    };
  });
}

async function saveUsernameToDB(username) {
  const db = await initIndexedDB();
  const tx = db.transaction(storeName, 'readwrite');
  const store = tx.objectStore(storeName);
  store.put({ username });
  return new Promise((resolve, reject) => {
    tx.oncomplete = () => resolve();
    tx.onerror = () => reject(tx.error);
  });
}

async function loadUsernamesFromDB() {
  const db = await initIndexedDB();
  const tx = db.transaction(storeName, 'readonly');
  const store = tx.objectStore(storeName);
  return new Promise((resolve, reject) => {
    const request = store.getAll();
    request.onsuccess = () => resolve(request.result.map(item => item.username));
    request.onerror = () => reject(request.error);
  });
}

async function populatePrevUsernames() {
  try {
    const usernames = await loadUsernamesFromDB();
    prevUsernamesEl.innerHTML = '<option value="">Select Previous Username</option>';
    usernames.forEach(username => {
      if (username !== currentUsername) {
        const option = document.createElement('option');
        option.value = username;
        option.textContent = username;
        prevUsernamesEl.appendChild(option);
      }
    });
    prevUsernamesEl.style.display = usernames.length > 0 ? 'block' : 'none';
  } catch (e) {
    console.error('Failed to load usernames:', e);
  }
}

// --- NETWORK STATUS ---
async function checkConnectivity() {
  try {
    const { data, error } = await supabase.from('messages').select('id').limit(1);
    if (error) throw error;
    statusEl.textContent = 'Online';
    statusEl.className = 'online';
  } catch (e) {
    statusEl.textContent = 'Offline';
    statusEl.className = 'offline';
  }
}
window.addEventListener('online', checkConnectivity);
window.addEventListener('offline', checkConnectivity);
checkConnectivity();

// --- HELPERS ---
function escapeHtml(s) { return String(s || '').replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;'); }
function fmtTime(ts) { const d = new Date(ts); return isNaN(d) ? '??:??' : d.toLocaleString(); }
function flashNameMsg(txt) { nameMsgEl.textContent = txt; setTimeout(() => nameMsgEl.textContent = '', 2000); }

// --- CHECK USERNAME AVAILABILITY ---
async function isUsernameAvailable(username) {
  try {
    const { data, error } = await supabase.from('messages').select('username').eq('username', username).limit(1);
    if (error) throw error;
    return data.length === 0;
  } catch (e) {
    console.error('Error checking username:', e);
    return false;
  }
}

// --- DISPLAY MESSAGE ---
function addMessageRow(row, pending = false) {
  const div = document.createElement('div');
  div.className = 'message' + (pending ? ' pending' : '');
  div.dataset.id = row.id;
  const delBtn = row.username === currentUsername ? ` <button class="delete-btn">X</button>` : '';
  div.innerHTML = `<span class="username">${escapeHtml(row.username)}</span>: 
  <span class="text">${escapeHtml(row.message)}</span> 
  <span class="ts">[${fmtTime(row.created_at)}]</span>${delBtn}`;
  chatEl.appendChild(div);
  if (autoScroll) chatEl.scrollTop = chatEl.scrollHeight;

  // delete message
  if (delBtn) {
    div.querySelector('.delete-btn').addEventListener('click', async () => {
      try {
        const { error } = await supabase.from('messages').delete().eq('id', row.id).eq('username', currentUsername);
        if (error) throw error;
        div.remove();
      } catch (e) { alert('Delete failed'); }
    });
  }
}

// --- LOAD MESSAGES ---
async function loadMessages() {
  try {
    const { data, error } = await supabase.from('messages').select('*').order('created_at', { ascending: true });
    if (error) throw error;
    chatEl.innerHTML = '';
    data.forEach(r => addMessageRow(r, false));
  } catch (e) { console.error(e); }
}

// --- SEND MESSAGE ---
async function sendMessage() {
  const txt = messageInput.value.trim();
  if (!txt) return;
  const row = { username: currentUsername, message: txt, created_at: new Date().toISOString() };
  addMessageRow(row, true);
  messageInput.value = '';
  try {
    const { error } = await supabase.from('messages').insert([row]);
    if (error) throw error;
    loadMessages();
  } catch (e) {
    console.error('Send failed', e);
    alert('Send failed');
  }
}

// --- AUTO SCROLL ---
autoScrollBtn.addEventListener('click', () => {
  autoScroll = !autoScroll;
  autoScrollBtn.textContent = 'Auto-Scroll: ' + (autoScroll ? 'On' : 'Off');
});

// --- DELETE ALL ---
deleteAllBtn.addEventListener('click', async () => {
  if (!confirm('Delete all your messages?')) return;
  try {
    const { error } = await supabase.from('messages').delete().eq('username', currentUsername);
    if (error) throw error;
    loadMessages();
  } catch (e) { alert('Delete failed'); }
});

// --- USERNAME ---
saveNameBtn.addEventListener('click', async () => {
  const val = usernameEl.value.trim();
  if (!val) {
    flashNameMsg('Enter a username');
    return;
  }
  if (val === currentUsername) {
    flashNameMsg('Username already in use');
    return;
  }
  const isAvailable = await isUsernameAvailable(val);
  if (!isAvailable) {
    flashNameMsg('Username already taken');
    return;
  }
  currentUsername = val;
  localStorage.setItem('chatUsername', currentUsername);
  await saveUsernameToDB(currentUsername);
  currentUsernameLabel.textContent = 'Username: ' + currentUsername;
  flashNameMsg('Username saved');
  loadMessages();
  populatePrevUsernames();
});

// --- SWITCH TO PREVIOUS USERNAME ---
prevUsernamesEl.addEventListener('change', async (e) => {
  const selectedUsername = e.target.value;
  if (selectedUsername) {
    currentUsername = selectedUsername;
    localStorage.setItem('chatUsername', currentUsername);
    currentUsernameLabel.textContent = 'Username: ' + currentUsername;
    flashNameMsg('Switched to ' + selectedUsername);
    loadMessages();
    populatePrevUsernames();
    e.target.value = '';
  }
});

// --- ENTER KEY ---
messageInput.addEventListener('keydown', (e) => {
  if (e.key === 'Enter') sendMessage();
});
usernameEl.addEventListener('keydown', (e) => {
  if (e.key === 'Enter') saveNameBtn.click();
});

// --- SEND BUTTON ---
sendBtn.addEventListener('click', sendMessage);

// --- REALTIME SUBSCRIPTION ---
supabase.channel('public:messages')
  .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, payload => {
    const row = payload.new;
    addMessageRow(row, false);
  })
  .on('postgres_changes', { event: 'DELETE', schema: 'public', table: 'messages' }, payload => {
    const delId = payload.old.id;
    const el = document.querySelector(`.message[data-id='${delId}']`);
    if (el) el.remove();
  })
  .subscribe();

// --- INITIAL LOAD ---
currentUsernameLabel.textContent = 'Username: ' + currentUsername;
loadMessages();
populatePrevUsernames();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Chat — Fixed Swipe & Delete</title>
<script type="module" src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm"></script>
<style>
:root{
  --bg:#0b1220; --panel:#071127; --input:#0f1724; --border:#1f2937;
  --text:#e6eef8; --muted:#94a3b8; --accent:#60a5fa; --btn:#2563eb;
  --err:#fb7185; --ok:#16a34a; --radius:8px; --shadow:0 2px 8px rgba(0,0,0,.3);
}
body{
  background:var(--bg);
  color:var(--text);
  font-family:Inter,system-ui,Segoe UI,Roboto,sans-serif;
  display:flex;
  justify-content:center;
  padding:24px;
  margin:0;
}
.wrap{
  width:100%; max-width:768px; position:relative; display:flex; flex-direction:column;
}
h1{
  color:var(--accent); text-align:center; margin-bottom:12px;
}
.top{
  display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;margin-bottom:8px;
}
#currentUsername{color:var(--muted);}
#username{
  background:var(--input); color:var(--text); border:1px solid var(--border);
  padding:8px 10px; border-radius:6px; width:220px
}
#saveName{
  background:var(--btn); color:#fff; border:none; padding:8px 12px; border-radius:6px; cursor:pointer
}
#chat{
  background:var(--panel); border-radius:8px; padding:12px;
  height:440px; overflow-y:auto; border:1px solid var(--border); box-shadow:var(--shadow);
  margin-bottom:8px; display:block;
}
.message{
  margin-bottom:10px; display:flex; gap:8px; align-items:center; justify-content:space-between;
}
.msgContent{
  display:flex; gap:8px; align-items:baseline; flex:1; word-break:break-word;
}
.username{color:var(--accent); font-weight:700; flex-shrink:0;}
.text{flex:1;}
.ts{color:var(--muted); font-size:.8rem; flex-shrink:0; white-space:nowrap;}
.delBtn{
  background:transparent;color:var(--err);border:none;cursor:pointer;font-size:.85rem;padding:6px 8px;border-radius:6px;
}
.delBtn:hover{background:rgba(255,0,0,0.06);}
#controls{display:flex; gap:8px; align-items:center; margin-top:auto;}
#messageInput{
  flex:1; padding:8px 10px; border-radius:8px; background:var(--input); color:var(--text); border:1px solid var(--border); max-height:40px;
}
#sendBtn{padding:8px 12px; background:var(--btn); color:white; border:none; border-radius:8px; cursor:pointer;}
.pending{opacity:.7; font-style:italic}
#nameMsg{color:var(--err); font-size:.9rem; margin-top:6px; min-height:1.2em}
#status{position:fixed; right:16px; top:16px; padding:8px 12px; border-radius:8px; font-weight:700; box-shadow:var(--shadow);}
.online{background:var(--ok); color:#052e0b;} .offline{background:#dc2626; color:#2b0202;}
#errorBox{margin-top:8px; color:var(--err); min-height:1.2em;}
#newBadge{
  position: absolute; right: 18px; bottom: 86px;
  background: var(--accent); color: #021124; padding: 6px 10px; border-radius: 999px;
  font-weight:700; box-shadow: var(--shadow); cursor: pointer; display:none; z-index:50;
}
@media (max-width:600px){
  #chat{height:280px;}
  body{padding:16px;}
  #username{width:100%; max-width:220px; margin-top:6px;}
  .top{flex-direction:column;align-items:flex-start;gap:8px;}
  #newBadge{bottom:100px; right:14px;}
}
</style>
</head>

<body>
<div id="status" class="offline">Offline</div>
<div class="wrap">
  <h1>Modern Chat App</h1>
  <div class="top">
    <div>
      <span id="currentUsername">Username: Guest</span>
      <input id="username" placeholder="Enter username" />
      <button id="saveName">Save</button>
      <div id="nameMsg"></div>
    </div>
    <div style="color:var(--muted)">Dark • Realtime</div>
  </div>

  <div id="chat" role="log" aria-live="polite"></div>
  <div id="newBadge">New messages ▾</div>

  <div id="controls">
    <input id="messageInput" placeholder="Type a message" autocomplete="off" />
    <button id="sendBtn">Send</button>
  </div>

  <div id="errorBox"></div>
</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';
const SUPABASE_URL = 'https://xvnbxdcqmfsnnvbugasi.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh2bmJ4ZGNxbWZzbm52YnVnYXNpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA2OTE5NjIsImV4cCI6MjA3NjI2Nzk2Mn0.vQELSSzCZtFi8jXGWcc8Qn_PV0W_dpmd_R3nF3zg0H0';
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY,{ realtime:{ timeout:15000 }});

const chatEl = document.getElementById('chat');
const usernameEl = document.getElementById('username');
const saveNameBtn = document.getElementById('saveName');
const nameMsgEl = document.getElementById('nameMsg');
const currentUsernameLabel = document.getElementById('currentUsername');
const messageInput = document.getElementById('messageInput');
const sendBtn = document.getElementById('sendBtn');
const statusEl = document.getElementById('status');
const errorBox = document.getElementById('errorBox');
const newBadge = document.getElementById('newBadge');

let currentUsername = localStorage.getItem('chatUsername')||'';
let oldUsernames = JSON.parse(localStorage.getItem('oldUsernames')||'[]');
const PENDING_KEY='chat_pending_v_fixed_scroll';
function updateNetworkUI(){
  const online=navigator.onLine;
  statusEl.textContent=online?'Online':'Offline';
  statusEl.className=online?'online':'offline';
  if(online) resendPending();
}
window.addEventListener('online',updateNetworkUI);
window.addEventListener('offline',updateNetworkUI);
updateNetworkUI();

function escapeHtml(s){ return String(s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
function fmtTime(ts){ if(!ts) return '??:??'; const d=new Date(ts); if(isNaN(d)) return '??:??'; return d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});}
function showError(msg){ errorBox.textContent=msg; setTimeout(()=>{ if(errorBox.textContent===msg) errorBox.textContent=''; },4000);}
function flashNameMsg(txt){ nameMsgEl.textContent=txt; setTimeout(()=>nameMsgEl.textContent='',2200); }

function getPending(){ return JSON.parse(localStorage.getItem(PENDING_KEY)||'[]'); }
function savePending(a){ localStorage.setItem(PENDING_KEY, JSON.stringify(a)); }
function addPending(obj){ const a=getPending(); a.push(obj); savePending(a); }
function removePending(obj){ const a=getPending().filter(x=>JSON.stringify(x)!==JSON.stringify(obj)); savePending(a); }

let userAtBottom=true;
function checkIfAtBottom(){
  const threshold=60;
  const nearBottom=(chatEl.scrollHeight-chatEl.scrollTop-chatEl.clientHeight)<=threshold;
  userAtBottom=nearBottom;
  if(userAtBottom) hideNewBadge();
}
chatEl.addEventListener('scroll',()=>{ checkIfAtBottom(); });

function showNewBadge(){ newBadge.style.display='block'; }
function hideNewBadge(){ newBadge.style.display='none'; }
newBadge.addEventListener('click',()=>{ scrollToBottom(); hideNewBadge(); });
function scrollToBottom(){ chatEl.scrollTop=chatEl.scrollHeight; userAtBottom=true; }

function createMessageElement(row,{pending=false}={}){
  const username=row.username||'Unknown';
  const message=row.message||'';
  const created_at=row.created_at||new Date().toISOString();
  const wrapper=document.createElement('div');
  wrapper.className='message'+(pending?'
  wrapper.className='message'+(pending?' pending':'');
  
  const contentDiv=document.createElement('div');
  contentDiv.className='msgContent';
  contentDiv.innerHTML=`<span class="username">${escapeHtml(username)}</span>
                        <span class="text">${escapeHtml(message)}</span>
                        <span class="ts">[${fmtTime(created_at)}]</span>`;
  
  const delBtn=document.createElement('button');
  delBtn.className='delBtn';
  delBtn.textContent='Del';
  delBtn.onclick=async ()=>{
    if(!currentUsername || username!==currentUsername) return showError('Can only delete your messages');
    try{
      const {error}=await supabase.from('messages').delete().eq('id',row.id);
      if(error) throw error;
      wrapper.remove();
    }catch(e){ showError('Delete failed'); }
  };

  wrapper.appendChild(contentDiv);
  if(username===currentUsername) wrapper.appendChild(delBtn);
  chatEl.appendChild(wrapper);

  if(userAtBottom) scrollToBottom();
  else showNewBadge();
}

async function resendPending(){
  for(const p of getPending()){
    try{
      const {error}=await supabase.from('messages').insert([p]);
      if(!error) removePending(p);
    }catch{}
  }
}

async function loadMessages(){
  try{
    const {data,error}=await supabase.from('messages').select().order('created_at',{ascending:true});
    if(error) return showError('Failed to load messages');
    chatEl.innerHTML='';
    data.forEach(d=>createMessageElement(d));
    getPending().forEach(p=>createMessageElement(p,{pending:true}));
    scrollToBottom();
  }catch{ showError('Unexpected load error'); }
}

async function sendMessage(){
  const txt=messageInput.value.trim();
  if(!txt) return;
  if(!currentUsername) return flashNameMsg('Set username first');

  const row={username:currentUsername,message:txt,created_at:new Date().toISOString()};
  messageInput.value='';

  if(!navigator.onLine){
    addPending(row);
    createMessageElement(row,{pending:true});
    return;
  }

  try{
    const {data,error}=await supabase.from('messages').insert([row]).select().single();
    if(error) throw error;
    createMessageElement(data);
  }catch{
    addPending(row);
    createMessageElement(row,{pending:true});
    showError('Send failed, queued locally');
  }
}

async function isUsernameTaken(name){
  try{
    const {data}=await supabase.from('messages').select('id').eq('username',name).limit(1);
    return data?.length>0;
  }catch{return true;}
}

saveNameBtn.addEventListener('click',async ()=>{
  const name=usernameEl.value.trim();
  if(!name) return flashNameMsg('Enter a username');
  if(oldUsernames.includes(name)){
    currentUsername=name;
    localStorage.setItem('chatUsername',name);
    currentUsernameLabel.textContent=`Username: ${name}`;
    return flashNameMsg('Switched to saved username');
  }
  if(await isUsernameTaken(name)){
    flashNameMsg('Username already taken');
    usernameEl.value=currentUsername;
    return;
  }
  currentUsername=name;
  localStorage.setItem('chatUsername',name);
  oldUsernames.push(name);
  localStorage.setItem('oldUsernames',JSON.stringify(oldUsernames));
  currentUsernameLabel.textContent=`Username: ${name}`;
  flashNameMsg('Username saved');
});

if(currentUsername){
  usernameEl.value=currentUsername;
  currentUsernameLabel.textContent=`Username: ${currentUsername}`;
}

async function subscribeRealtime(){
  try{
    await supabase.removeAllSubscriptions();
    const channel=supabase.channel('realtime-messages',{config:{broadcast:{ack:true}}});
    channel.on('postgres_changes',{event:'INSERT',schema:'public',table:'messages'},payload=>{
      const newMsg=payload.new;
      createMessageElement(newMsg);
    }).subscribe();
  }catch{ showError('Realtime failed'); }
}

(async()=>{
  await loadMessages();
  await subscribeRealtime();
  sendBtn.addEventListener('click',sendMessage);
  messageInput.addEventListener('keydown',e=>{if(e.key==='Enter') sendMessage();});
  window.addEventListener('online',resendPending);
})();
</script>
</body>
</html>
